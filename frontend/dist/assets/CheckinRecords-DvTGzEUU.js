import{d as pe,r as k,c as j,Q as he,a1 as me,R as ve,e as u,g as v,h as l,t as o,w as a,i,E as F,M as d,q as ke,aa as W,ab as q,P as _e,a7 as fe,N as C,l as K,L as E,o as c,a9 as ge,_ as ye}from"./index-CC1QUR8I.js";import{r as Q}from"./request-RQfx8Tvg.js";import{g as be}from"./employees-BSCZnefs.js";import{g as $e}from"./worksites-CwXYUNkP.js";const Re=(g={})=>Q({url:"/checkins/records",method:"get",params:g}),we=(g={})=>Q({url:"/checkins/records/export",method:"get",params:g,responseType:"blob"}),H=g=>{if(!g)return"";const p=new Date(g);if(isNaN(p.getTime()))return"";const w=p.getFullYear(),D=String(p.getMonth()+1).padStart(2,"0"),S=String(p.getDate()).padStart(2,"0"),U=String(p.getHours()).padStart(2,"0"),Y=String(p.getMinutes()).padStart(2,"0"),V=String(p.getSeconds()).padStart(2,"0");return`${w}-${D}-${S} ${U}:${Y}:${V}`},Ve={class:"checkin-records"},Ce={class:"page-header"},De={class:"header-actions"},Se={class:"employee-info"},Ue={class:"name"},Me={class:"phone"},Pe={key:0,class:"location-info"},ze={class:"address"},Ee={key:0,class:"coordinates"},Ye={key:1,class:"text-gray-400"},Oe={key:1,class:"text-gray-400"},Te={class:"pagination-container"},Be={key:0,class:"record-details"},Fe={key:0},Ie={key:1},Ne={key:0,class:"device-info"},Le={key:1},je={key:0,class:"photo-section"},We=pe({__name:"CheckinRecords",setup(g){const p=k(!1),w=k(!1),D=k([]),S=k([]),U=k([]),Y=k([]),V=k(!1),O=k(!1),s=k(null),M=k(""),b=k(null),r=j({search:"",employee_id:"",worksite_id:"",checkin_type:void 0,status:void 0}),h=j({page:1,limit:20,total:0}),T=he(()=>{const e={page:h.page,limit:h.limit,...r};return b.value&&(e.start_date=b.value[0],e.end_date=b.value[1]),Object.keys(e).forEach(n=>{(e[n]===""||e[n]===void 0)&&delete e[n]}),e}),$=async()=>{p.value=!0;try{const e=await Re(T.value);D.value=e.data.records,h.total=e.data.total}catch(e){console.error("获取签到记录失败:",e),F.error("获取签到记录失败")}finally{p.value=!1}},A=async()=>{try{const e=await be({page:1,limit:1e3});S.value=e.data.employees}catch(e){console.error("获取员工列表失败:",e)}},G=async()=>{try{const e=await $e({page:1,limit:1e3});U.value=e.data.worksites}catch(e){console.error("获取工地列表失败:",e)}},B=()=>{h.page=1,$()},J=()=>{Object.assign(r,{search:"",employee_id:"",worksite_id:"",checkin_type:void 0,status:void 0}),b.value=null,B()},X=()=>{$()},Z=e=>{h.limit=e,h.page=1,$()},x=e=>{h.page=e,$()},ee=e=>{Y.value=e},te=e=>{s.value=e,V.value=!0},le=e=>{M.value=e,O.value=!0},ae=async()=>{try{await ge.confirm("确定要导出当前筛选条件下的所有签到记录吗？","导出确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),w.value=!0;const e=await we(T.value),n=window.URL.createObjectURL(e),m=document.createElement("a");m.href=n,m.download=`签到记录_${new Date().toISOString().slice(0,10)}.xlsx`,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(n),F.success("导出成功")}catch(e){e!=="cancel"&&(console.error("导出失败:",e),F.error("导出失败"))}finally{w.value=!1}};return me(()=>T.value,()=>{$()},{deep:!0}),ve(()=>{$(),A(),G()}),(e,n)=>{const m=i("el-button"),oe=i("el-input"),y=i("el-form-item"),R=i("el-option"),P=i("el-select"),ne=i("el-date-picker"),se=i("el-form"),I=i("el-card"),_=i("el-table-column"),z=i("el-tag"),ce=i("el-table"),ie=i("el-pagination"),f=i("el-descriptions-item"),de=i("el-descriptions"),N=i("el-image"),L=i("el-dialog"),re=fe("loading");return c(),u("div",Ve,[v("div",Ce,[v("h2",null,o(e.$t("checkinRecords.title")),1),v("div",De,[l(m,{type:"primary",onClick:ae,loading:w.value,icon:"Download"},{default:a(()=>[d(o(e.$t("checkinRecords.export")),1)]),_:1},8,["loading"]),l(m,{onClick:X,loading:p.value,icon:"Refresh"},{default:a(()=>[d(o(e.$t("common.refresh")),1)]),_:1},8,["loading"])])]),l(I,{class:"filter-card",shadow:"never"},{default:a(()=>[l(se,{model:r,inline:"",class:"filter-form"},{default:a(()=>[l(y,{label:e.$t("checkinRecords.search")},{default:a(()=>[l(oe,{modelValue:r.search,"onUpdate:modelValue":n[0]||(n[0]=t=>r.search=t),placeholder:e.$t("checkinRecords.searchPlaceholder"),style:{width:"200px"},clearable:"",onKeyup:ke(B,["enter"])},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l(y,{label:e.$t("checkinRecords.employee")},{default:a(()=>[l(P,{modelValue:r.employee_id,"onUpdate:modelValue":n[1]||(n[1]=t=>r.employee_id=t),placeholder:e.$t("checkinRecords.selectEmployee"),style:{width:"200px"},clearable:"",filterable:""},{default:a(()=>[(c(!0),u(W,null,q(S.value,t=>(c(),C(R,{key:t.employee_id,label:`${t.first_name} ${t.last_name} (${t.phone})`,value:t.employee_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),l(y,{label:e.$t("checkinRecords.worksite")},{default:a(()=>[l(P,{modelValue:r.worksite_id,"onUpdate:modelValue":n[2]||(n[2]=t=>r.worksite_id=t),placeholder:e.$t("checkinRecords.selectWorksite"),style:{width:"200px"},clearable:""},{default:a(()=>[(c(!0),u(W,null,q(U.value,t=>(c(),C(R,{key:t.worksite_id,label:t.name,value:t.worksite_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),l(y,{label:e.$t("checkinRecords.type")},{default:a(()=>[l(P,{modelValue:r.checkin_type,"onUpdate:modelValue":n[3]||(n[3]=t=>r.checkin_type=t),placeholder:e.$t("checkinRecords.selectType"),style:{width:"120px"},clearable:""},{default:a(()=>[l(R,{label:e.$t("checkinRecords.checkinIn"),value:"in"},null,8,["label"]),l(R,{label:e.$t("checkinRecords.checkinOut"),value:"out"},null,8,["label"])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),l(y,{label:e.$t("checkinRecords.status")},{default:a(()=>[l(P,{modelValue:r.status,"onUpdate:modelValue":n[4]||(n[4]=t=>r.status=t),placeholder:e.$t("checkinRecords.selectStatus"),style:{width:"120px"},clearable:""},{default:a(()=>[l(R,{label:e.$t("checkinRecords.success"),value:"success"},null,8,["label"]),l(R,{label:e.$t("checkinRecords.failed"),value:"failed"},null,8,["label"])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),l(y,{label:e.$t("checkinRecords.dateRange")},{default:a(()=>[l(ne,{modelValue:b.value,"onUpdate:modelValue":n[5]||(n[5]=t=>b.value=t),type:"daterange","range-separator":e.$t("common.to"),"start-placeholder":e.$t("common.startDate"),"end-placeholder":e.$t("common.endDate"),format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue","range-separator","start-placeholder","end-placeholder"])]),_:1},8,["label"]),l(y,null,{default:a(()=>[l(m,{type:"primary",onClick:B,icon:"Search"},{default:a(()=>[d(o(e.$t("common.search")),1)]),_:1}),l(m,{onClick:J,icon:"Refresh"},{default:a(()=>[d(o(e.$t("common.reset")),1)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(I,{shadow:"never"},{default:a(()=>[_e((c(),C(ce,{data:D.value,stripe:"",onSelectionChange:ee},{default:a(()=>[l(_,{type:"selection",width:"55"}),l(_,{label:e.$t("checkinRecords.employee"),"min-width":"120"},{default:a(({row:t})=>[v("div",Se,[v("div",Ue,o(t.employee_name),1),v("div",Me,o(t.phone_number),1)])]),_:1},8,["label"]),l(_,{label:e.$t("checkinRecords.worksite"),prop:"worksite_name","min-width":"120"},null,8,["label"]),l(_,{label:e.$t("checkinRecords.type"),width:"80",align:"center"},{default:a(({row:t})=>[l(z,{type:t.checkin_type==="in"?"success":"warning"},{default:a(()=>[d(o(t.checkin_type==="in"?e.$t("checkinRecords.checkinIn"):e.$t("checkinRecords.checkinOut")),1)]),_:2},1032,["type"])]),_:1},8,["label"]),l(_,{label:e.$t("checkinRecords.time"),width:"180"},{default:a(({row:t})=>[d(o(K(H)(t.checkin_time)),1)]),_:1},8,["label"]),l(_,{label:e.$t("checkinRecords.location"),"min-width":"200"},{default:a(({row:t})=>[t.address?(c(),u("div",Pe,[v("div",ze,o(t.address),1),t.latitude&&t.longitude?(c(),u("div",Ee,o(t.latitude.toFixed(6))+", "+o(t.longitude.toFixed(6)),1)):E("",!0)])):(c(),u("span",Ye,o(e.$t("common.noData")),1))]),_:1},8,["label"]),l(_,{label:e.$t("checkinRecords.photo"),width:"80",align:"center"},{default:a(({row:t})=>[t.photo_data?(c(),C(m,{key:0,size:"small",type:"primary",text:"",onClick:ue=>le(t.photo_data),icon:"Picture"},{default:a(()=>[d(o(e.$t("checkinRecords.viewPhoto")),1)]),_:2},1032,["onClick"])):(c(),u("span",Oe,o(e.$t("common.noData")),1))]),_:1},8,["label"]),l(_,{label:e.$t("checkinRecords.status"),width:"80",align:"center"},{default:a(({row:t})=>[l(z,{type:t.status==="success"?"success":"danger"},{default:a(()=>[d(o(t.status==="success"?e.$t("checkinRecords.success"):e.$t("checkinRecords.failed")),1)]),_:2},1032,["type"])]),_:1},8,["label"]),l(_,{label:e.$t("common.actions"),width:"120",align:"center",fixed:"right"},{default:a(({row:t})=>[l(m,{size:"small",type:"primary",text:"",onClick:ue=>te(t),icon:"View"},{default:a(()=>[d(o(e.$t("common.details")),1)]),_:2},1032,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[re,p.value]]),v("div",Te,[l(ie,{"current-page":h.page,"onUpdate:currentPage":n[6]||(n[6]=t=>h.page=t),"page-size":h.limit,"onUpdate:pageSize":n[7]||(n[7]=t=>h.limit=t),total:h.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Z,onCurrentChange:x},null,8,["current-page","page-size","total"])])]),_:1}),l(L,{modelValue:V.value,"onUpdate:modelValue":n[8]||(n[8]=t=>V.value=t),title:e.$t("checkinRecords.details"),width:"600px",onClosed:n[9]||(n[9]=t=>s.value=null)},{default:a(()=>[s.value?(c(),u("div",Be,[l(de,{column:2,border:""},{default:a(()=>[l(f,{label:e.$t("checkinRecords.employee")},{default:a(()=>[d(o(s.value.employee_name),1)]),_:1},8,["label"]),l(f,{label:e.$t("checkinRecords.phone")},{default:a(()=>[d(o(s.value.phone_number),1)]),_:1},8,["label"]),l(f,{label:e.$t("checkinRecords.worksite")},{default:a(()=>[d(o(s.value.worksite_name),1)]),_:1},8,["label"]),l(f,{label:e.$t("checkinRecords.type")},{default:a(()=>[l(z,{type:s.value.checkin_type==="in"?"success":"warning"},{default:a(()=>[d(o(s.value.checkin_type==="in"?e.$t("checkinRecords.checkinIn"):e.$t("checkinRecords.checkinOut")),1)]),_:1},8,["type"])]),_:1},8,["label"]),l(f,{label:e.$t("checkinRecords.time")},{default:a(()=>[d(o(K(H)(s.value.checkin_time)),1)]),_:1},8,["label"]),l(f,{label:e.$t("checkinRecords.status")},{default:a(()=>[l(z,{type:s.value.status==="success"?"success":"danger"},{default:a(()=>[d(o(s.value.status==="success"?e.$t("checkinRecords.success"):e.$t("checkinRecords.failed")),1)]),_:1},8,["type"])]),_:1},8,["label"]),l(f,{label:e.$t("checkinRecords.address"),span:2},{default:a(()=>[d(o(s.value.address||e.$t("common.noData")),1)]),_:1},8,["label"]),l(f,{label:e.$t("checkinRecords.coordinates"),span:2},{default:a(()=>[s.value.latitude&&s.value.longitude?(c(),u("span",Fe,o(s.value.latitude.toFixed(6))+", "+o(s.value.longitude.toFixed(6))+" ("+o(e.$t("checkinRecords.accuracy"))+": "+o(s.value.location_accuracy)+"m) ",1)):(c(),u("span",Ie,o(e.$t("common.noData")),1))]),_:1},8,["label"]),l(f,{label:e.$t("checkinRecords.deviceInfo"),span:2},{default:a(()=>[s.value.device_info?(c(),u("div",Ne,[v("div",null,o(e.$t("checkinRecords.deviceId"))+": "+o(s.value.device_info.device_id),1),v("div",null,o(e.$t("checkinRecords.deviceType"))+": "+o(s.value.device_info.device_type),1),v("div",null,o(e.$t("checkinRecords.appVersion"))+": "+o(s.value.device_info.app_version),1)])):(c(),u("span",Le,o(e.$t("common.noData")),1))]),_:1},8,["label"])]),_:1}),s.value.photo_data?(c(),u("div",je,[v("h4",null,o(e.$t("checkinRecords.checkinPhoto")),1),l(N,{src:s.value.photo_data,"preview-src-list":[s.value.photo_data],fit:"contain",style:{width:"100%","max-height":"300px"},"preview-teleported":""},null,8,["src","preview-src-list"])])):E("",!0)])):E("",!0)]),_:1},8,["modelValue","title"]),l(L,{modelValue:O.value,"onUpdate:modelValue":n[10]||(n[10]=t=>O.value=t),title:e.$t("checkinRecords.checkinPhoto"),width:"500px"},{default:a(()=>[M.value?(c(),C(N,{key:0,src:M.value,"preview-src-list":[M.value],fit:"contain",style:{width:"100%"},"preview-teleported":""},null,8,["src","preview-src-list"])):E("",!0)]),_:1},8,["modelValue","title"])])}}}),Ae=ye(We,[["__scopeId","data-v-4e1a73ef"]]);export{Ae as default};
