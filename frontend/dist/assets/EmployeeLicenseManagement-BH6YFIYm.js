import{d as qe,b as We,ad as He,u as Oe,r as y,c as K,Q as Z,R as je,e as C,g as p,h as a,t as i,N as g,L as M,P as z,l as fe,w as s,i as m,E as w,aa as X,ab as Y,M as _,a7 as _e,an as Qe,a9 as Ge,o as d,_ as Je}from"./index-CC1QUR8I.js";import{g as Ke}from"./employees-BSCZnefs.js";import{a as Xe,b as Ye,g as el,u as ll,c as al,d as sl,f as tl,h as nl}from"./licenses-BWMabNXL.js";import"./request-RQfx8Tvg.js";const il={class:"license-management"},ol={class:"page-header"},rl={class:"actions"},ul={class:"card-header"},dl={key:1,style:{color:"#bbb"}},cl={class:"el-upload__text"},pl={key:0,class:"ocr-preview"},ml={class:"batch-import-content"},fl={class:"el-upload__tip"},_l={class:"el-upload__tip"},yl={key:0,class:"import-progress"},vl={key:1,class:"import-result"},gl={key:0,style:{"margin-top":"10px"}},bl={class:"dialog-footer"},hl=qe({__name:"EmployeeLicenseManagement",setup(wl){const{locale:q,t:o}=We(),{hasPermission:ee}=He(),le=Oe(),b=y(""),W=y([]),H=y([]),ae=y([]),O=y(!1),j=y(!1),k=y(!1),T=y(null),I=y(""),U=y(""),x=y(""),se=y([]),R=y([]),V=y(null),D=y(""),B=y(!1),A=y(!1),h=K({csvFile:[],zipFile:[]}),f=K({show:!1,percentage:0,status:"",text:""}),$=y(null),r=K({license_type_id:"",number:"",issue_date:"",expiry_date:"",custom_advance_days:null}),te=y(),ye={license_type_id:[{required:!0,message:o("license.type")+(o("common.required")||"*"),trigger:"change"}],expiry_date:[{required:!0,message:o("license.expiryDate")+(o("common.required")||"*"),trigger:"change"}]},ve=Z(()=>{const e=W.value.find(l=>l.employee_id===b.value);return e?e.first_name+" "+e.last_name:""}),ne=Z(()=>h.csvFile.length>0&&!A.value),ge=Z(()=>T.value?o("license.edit"):o("license.add"));function ie(e){return(q.value||"").startsWith("zh")&&e.name_zh||e.name_en}function be(e){return`${e.employee_id} - ${e.first_name} ${e.last_name}`}function he(e){const l=e.days_remaining;let t="";e.status==="expired"?t="danger":e.status==="expiring"?t=l<=7?"danger":l<=14?"warning":"info":t="success";const u=(q.value||"").startsWith("zh")?e.LicenseType?.name_zh||e.LicenseType?.name_en:e.LicenseType?.name_en||e.LicenseType?.name_zh,L=e.status==="expired"?o("license.expired"):e.status==="expiring"?o("license.expiringSoon"):o("license.normal");return{...e,licenseName:u,statusTag:t,statusLabel:L}}const we=Z(()=>ae.value.filter(e=>!(I.value&&!(`${e.number||""}`.toLowerCase().includes(I.value.toLowerCase())||`${e.licenseName||""}`.toLowerCase().includes(I.value.toLowerCase()))||U.value&&e.status!==U.value||x.value&&e.license_type_id!==x.value)));async function $e(){const e=await Ke({page:1,limit:500});W.value=e.data.employees||e.data}async function Le(){try{const e=await Xe();H.value=e.data}catch(e){console.error("Failed to load license types:",e),w.error("加载许可证类型失败")}}async function F(){if(b.value){O.value=!0;try{const e=await Ye(b.value),l=new Date;ae.value=e.data.map(t=>{const v=new Date(t.expiry_date),u=Math.floor((v.getTime()-l.getTime())/(24*3600*1e3)),L=t.custom_advance_days||t.LicenseType?.default_advance_days||30;let c="normal";return u<0?c="expired":u<=L&&(c="expiring"),he({...t,days_remaining:u,status:c})})}finally{O.value=!1}}}async function S(){const e=await el({within:60,limit:50,sortBy:"expiry_date",sortOrder:"ASC"}),l=(q.value||"").startsWith("zh"),t=e.data?.licenses||e.data||[];se.value=t.map(v=>{const u=v.days_remaining;let L="";v.status==="expired"?L="danger":v.status==="expiring"?L=u<=7?"danger":u<=14?"warning":"info":L="success";const c=l?v.license?.name_zh||v.license?.name_en:v.license?.name_en||v.license?.name_zh,Q=v.status==="expired"?o("license.expired"):v.status==="expiring"?o("license.expiringSoon"):o("license.normal");return{...v,licenseName:c,statusTag:L,statusLabel:Q}})}function Ce(){T.value=null,Object.assign(r,{license_type_id:"",number:"",issue_date:"",expiry_date:"",custom_advance_days:null}),V.value=null,R.value=[],D.value="",k.value=!0}function Ee(e){T.value=e.employee_license_id||e.id,Object.assign(r,{license_type_id:e.license_type_id,number:e.number,issue_date:e.issue_date,expiry_date:e.expiry_date,custom_advance_days:e.custom_advance_days}),V.value=null,R.value=[],D.value=e.ocr_raw_text||"",k.value=!0}function Te(e){V.value=e.raw,D.value=""}async function ke(){b.value&&await te.value?.validate(async e=>{if(e){j.value=!0;try{if(V.value){const l=new FormData;l.append("license_type_id",r.license_type_id),r.number&&l.append("number",r.number),r.issue_date&&l.append("issue_date",r.issue_date),l.append("expiry_date",r.expiry_date),r.custom_advance_days!=null&&l.append("custom_advance_days",r.custom_advance_days),l.append("file",V.value),T.value?await ll(T.value,l):await al(b.value,l)}else T.value?await sl(T.value,r):await tl(b.value,r);w.success(o("common.save")),k.value=!1,V.value=null,R.value=[],F(),S()}catch(l){console.error("保存证件失败:",l);let t="保存失败";l?.response?.data?.message?t=l.response.data.message:l?.message?t=l.message:typeof l=="string"&&(t=l),t.includes("File too large")||t.includes("文件过大")?t=o("license.fileTooLarge")||"文件过大，请选择小于5MB的文件":t.includes("不支持的文件类型")||t.includes("Unsupported file type")?t=o("license.unsupportedFileType")||"不支持的文件类型，请上传图片或PDF文件":t.includes("license_type_id required")?t=o("license.licenseTypeRequired")||"请选择证件类型":t.includes("expiry_date required")&&(t=o("license.expiryDateRequired")||"请选择到期日期"),w.error(t)}finally{j.value=!1}}})}async function Ve(e){try{await Ge.confirm(o("license.deleteConfirm"),o("common.confirm"),{type:"warning"}),await nl(e.employee_license_id||e.id),w.success(o("common.delete")),F(),S()}catch(l){if(l!=="cancel"){console.error("删除证件失败:",l);let t="删除失败";l?.response?.data?.message?t=l.response.data.message:l?.message&&(t=l.message),t.includes("not found")||t.includes("不存在")?t="证件不存在或已被删除":(t.includes("permission")||t.includes("权限"))&&(t="没有权限删除此证件"),w.error(t)}}}function Fe(e){if(!e.file_url)return;const l=e.file_url;/\.(png|jpg|jpeg|gif)$/i.test(l)||/\.pdf$/i.test(l),window.open(l,"_blank")}function ze(){B.value=!0,h.csvFile=[],h.zipFile=[],f.show=!1,f.percentage=0,f.status="",f.text="",$.value=null}function Ie(e){return e.type==="text/csv"||e.name.endsWith(".csv")?(e.size/1024/1024<10||w.error(o("license.fileSizeLimit")),!1):(w.error(o("license.csvFileTypeError")),!1)}function De(e){h.csvFile=[e]}function Se(e){return e.type==="application/zip"||e.name.endsWith(".zip")?(e.size/1024/1024<100||w.error(o("license.zipFileSizeLimit")),!1):(w.error(o("license.zipFileTypeError")),!1)}function Ne(e){h.zipFile=[e]}async function Pe(){if(ne.value){A.value=!0,f.show=!0,f.percentage=0,f.status="",f.text=o("license.preparingImport"),$.value=null;try{const e=new FormData;h.csvFile.length>0&&e.append("csv",h.csvFile[0].raw),h.zipFile.length>0&&e.append("attachments",h.zipFile[0].raw),f.percentage=20,f.text=o("license.uploadingFiles");const l=await fetch("/api/v1/licenses/import",{method:"POST",body:e,headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(f.percentage=80,f.text=o("license.processingData"),!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);const t=await l.json();f.percentage=100,f.status=t.success?"success":"exception",f.text=o("license.importComplete"),$.value={total:t.data.total||0,success:t.data.success||0,failed:t.data.failed||0,errors:t.data.errors||[]},t.success?(w.success(o("license.importSuccess")),b.value&&F(),S()):w.error(t.message||o("license.importFailed"))}catch(e){console.error("Batch import error:",e),f.status="exception",f.text=o("license.importError");let l=o("license.importError");e?.response?.data?.message?l=e.response.data.message:e?.message&&(e.message.includes("HTTP 413")?l=o("license.fileTooLarge")||"文件过大，请减小文件大小后重试":e.message.includes("HTTP 400")?l="文件格式错误，请检查CSV格式是否正确":e.message.includes("HTTP 401")?l="登录已过期，请重新登录":e.message.includes("HTTP 403")?l="没有权限执行批量导入操作":e.message.includes("Failed to fetch")||e.message.includes("Network")?l=o("license.networkError")||"网络连接失败，请检查网络后重试":l=e.message),w.error(l)}finally{A.value=!1}}}return je(()=>{Le(),S(),ee("LICENSE_VIEW_ALL")?$e():le.user?.employee_id&&(b.value=le.user.employee_id,F())}),(e,l)=>{const t=m("el-option"),v=m("el-select"),u=m("el-button"),L=m("el-input"),c=m("el-table-column"),Q=m("el-tooltip"),N=m("el-tag"),G=m("el-table"),oe=m("el-card"),re=m("el-col"),Me=m("el-row"),E=m("el-form-item"),ue=m("el-date-picker"),Ue=m("el-input-number"),xe=m("el-icon"),J=m("el-upload"),de=m("el-form"),ce=m("el-dialog"),pe=m("el-alert"),Re=m("el-progress"),Be=m("el-collapse-item"),Ae=m("el-collapse"),P=_e("permission"),Ze=_e("loading");return d(),C("div",il,[p("div",ol,[p("h2",null,i(e.$t("license.title")),1),p("div",rl,[fe(ee)("LICENSE_VIEW_ALL")?(d(),g(v,{key:0,modelValue:b.value,"onUpdate:modelValue":l[0]||(l[0]=n=>b.value=n),filterable:"",clearable:"",placeholder:e.$t("employee.searchPlaceholder"),style:{width:"240px"},onChange:F},{default:s(()=>[(d(!0),C(X,null,Y(W.value,n=>(d(),g(t,{key:n.employee_id,label:be(n),value:n.employee_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])):M("",!0),z((d(),g(u,{type:"primary",disabled:!b.value,onClick:Ce},{default:s(()=>[_(i(e.$t("license.add")),1)]),_:1},8,["disabled"])),[[P,"LICENSE_CREATE"]]),z((d(),g(u,{type:"warning",onClick:ze},{default:s(()=>[_(i(e.$t("license.batchImport")),1)]),_:1})),[[P,"LICENSE_BATCH_IMPORT"]]),z((d(),g(u,{type:"info",onClick:l[1]||(l[1]=n=>e.$router.push("/admin/licenses/ocr-confirmation"))},{default:s(()=>[_(i(e.$t("license.ocrConfirmation")),1)]),_:1})),[[P,"LICENSE_EDIT"]]),a(u,{onClick:F,disabled:!b.value},{default:s(()=>[_(i(e.$t("license.refresh")),1)]),_:1},8,["disabled"]),a(u,{onClick:S},{default:s(()=>[_(i(e.$t("license.widgetTitle")),1)]),_:1})])]),a(Me,{gutter:20},{default:s(()=>[a(re,{span:16},{default:s(()=>[a(oe,null,{header:s(()=>[p("div",ul,[p("span",null,i(e.$t("license.title"))+" - "+i(ve.value),1),p("div",null,[a(L,{modelValue:I.value,"onUpdate:modelValue":l[2]||(l[2]=n=>I.value=n),size:"small",placeholder:e.$t("license.searchPlaceholder"),style:{width:"200px","margin-right":"8px"},clearable:""},null,8,["modelValue","placeholder"]),a(v,{modelValue:U.value,"onUpdate:modelValue":l[3]||(l[3]=n=>U.value=n),size:"small",clearable:"",placeholder:e.$t("license.filterStatus"),style:{width:"140px","margin-right":"8px"}},{default:s(()=>[a(t,{label:e.$t("license.normal"),value:"normal"},null,8,["label"]),a(t,{label:e.$t("license.expiringSoon"),value:"expiring"},null,8,["label"]),a(t,{label:e.$t("license.expired"),value:"expired"},null,8,["label"])]),_:1},8,["modelValue","placeholder"]),a(v,{modelValue:x.value,"onUpdate:modelValue":l[4]||(l[4]=n=>x.value=n),size:"small",clearable:"",placeholder:e.$t("license.filterType"),style:{width:"160px","margin-right":"8px"}},{default:s(()=>[(d(!0),C(X,null,Y(H.value,n=>(d(),g(t,{key:n.id,label:ie(n),value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])])])]),default:s(()=>[z((d(),g(G,{data:we.value,size:"small",style:{width:"100%"}},{default:s(()=>[a(c,{prop:"licenseName",label:e.$t("license.type"),width:"220"},null,8,["label"]),a(c,{prop:"number",label:e.$t("license.number"),width:"150"},null,8,["label"]),a(c,{prop:"issue_date",label:e.$t("license.issueDate"),width:"120"},null,8,["label"]),a(c,{prop:"expiry_date",label:e.$t("license.expiryDate"),width:"120"},null,8,["label"]),a(c,{prop:"days_remaining",label:e.$t("license.daysRemaining"),width:"120"},null,8,["label"]),a(c,{label:e.$t("license.file"),width:"90"},{default:s(n=>[n.row.file_url?(d(),g(Q,{key:0,content:n.row.file_url,placement:"top"},{default:s(()=>[a(u,{link:"",type:"primary",size:"small",onClick:me=>Fe(n.row)},{default:s(()=>[...l[14]||(l[14]=[_("📎",-1)])]),_:2},1032,["onClick"])]),_:2},1032,["content"])):(d(),C("span",dl,"--"))]),_:1},8,["label"]),a(c,{label:e.$t("license.ocrResult"),width:"130"},{default:s(n=>[n.row.ocr_status==="parsed"?(d(),g(N,{key:0,type:"success",size:"small"},{default:s(()=>[_(i(e.$t("license.ocrParsed")),1)]),_:1})):n.row.ocr_status==="low_confidence"?(d(),g(N,{key:1,type:"warning",size:"small"},{default:s(()=>[_(i(e.$t("license.ocrLow")),1)]),_:1})):(d(),g(N,{key:2,type:"info",size:"small"},{default:s(()=>[_(i(e.$t("license.ocrNone")),1)]),_:1}))]),_:1},8,["label"]),a(c,{prop:"statusLabel",label:e.$t("license.status"),width:"120"},{default:s(n=>[a(N,{type:n.row.statusTag},{default:s(()=>[_(i(n.row.statusLabel),1)]),_:2},1032,["type"])]),_:1},8,["label"]),a(c,{label:e.$t("license.actions"),width:"230",fixed:"right"},{default:s(n=>[z((d(),g(u,{size:"small",onClick:me=>Ee(n.row)},{default:s(()=>[_(i(e.$t("license.edit")),1)]),_:2},1032,["onClick"])),[[P,"LICENSE_EDIT"]]),z((d(),g(u,{size:"small",type:"danger",onClick:me=>Ve(n.row)},{default:s(()=>[_(i(e.$t("common.delete")),1)]),_:2},1032,["onClick"])),[[P,"LICENSE_DELETE"]])]),_:1},8,["label"])]),_:1},8,["data"])),[[Ze,O.value]])]),_:1})]),_:1}),a(re,{span:8},{default:s(()=>[a(oe,null,{header:s(()=>[p("span",null,i(e.$t("license.widgetTitle")),1)]),default:s(()=>[a(G,{data:se.value,size:"small",style:{width:"100%"},height:"400px"},{default:s(()=>[a(c,{prop:"name",label:e.$t("license.employee"),width:"140"},null,8,["label"]),a(c,{prop:"licenseName",label:e.$t("license.type"),width:"180"},null,8,["label"]),a(c,{prop:"days_remaining",label:e.$t("license.daysRemaining"),width:"100"},null,8,["label"]),a(c,{prop:"statusLabel",label:e.$t("license.status"),width:"120"},{default:s(n=>[a(N,{type:n.row.statusTag,size:"small"},{default:s(()=>[_(i(n.row.statusLabel),1)]),_:2},1032,["type"])]),_:1},8,["label"])]),_:1},8,["data"])]),_:1})]),_:1})]),_:1}),a(ce,{modelValue:k.value,"onUpdate:modelValue":l[11]||(l[11]=n=>k.value=n),title:ge.value,width:"500px","close-on-click-modal":!1},{footer:s(()=>[a(u,{onClick:l[10]||(l[10]=n=>k.value=!1)},{default:s(()=>[_(i(e.$t("common.cancel")),1)]),_:1}),a(u,{type:"primary",onClick:ke,loading:j.value},{default:s(()=>[_(i(e.$t("common.save")),1)]),_:1},8,["loading"])]),default:s(()=>[a(de,{model:r,"label-width":"120px",rules:ye,ref_key:"formRef",ref:te},{default:s(()=>[a(E,{label:e.$t("license.type"),prop:"license_type_id"},{default:s(()=>[a(v,{modelValue:r.license_type_id,"onUpdate:modelValue":l[5]||(l[5]=n=>r.license_type_id=n),filterable:"",style:{width:"100%"}},{default:s(()=>[(d(!0),C(X,null,Y(H.value,n=>(d(),g(t,{key:n.id,value:n.id,label:ie(n)},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),a(E,{label:e.$t("license.number"),prop:"number"},{default:s(()=>[a(L,{modelValue:r.number,"onUpdate:modelValue":l[6]||(l[6]=n=>r.number=n)},null,8,["modelValue"])]),_:1},8,["label"]),a(E,{label:e.$t("license.issueDate"),prop:"issue_date"},{default:s(()=>[a(ue,{modelValue:r.issue_date,"onUpdate:modelValue":l[7]||(l[7]=n=>r.issue_date=n),type:"date",style:{width:"100%"}},null,8,["modelValue"])]),_:1},8,["label"]),a(E,{label:e.$t("license.expiryDate"),prop:"expiry_date"},{default:s(()=>[a(ue,{modelValue:r.expiry_date,"onUpdate:modelValue":l[8]||(l[8]=n=>r.expiry_date=n),type:"date",style:{width:"100%"}},null,8,["modelValue"])]),_:1},8,["label"]),a(E,{label:e.$t("license.customAdvanceDays"),prop:"custom_advance_days"},{default:s(()=>[a(Ue,{modelValue:r.custom_advance_days,"onUpdate:modelValue":l[9]||(l[9]=n=>r.custom_advance_days=n),min:0,max:180},null,8,["modelValue"])]),_:1},8,["label"]),a(E,{label:e.$t("license.upload")},{default:s(()=>[a(J,{class:"license-uploader",drag:"","auto-upload":!1,"on-change":Te,"file-list":R.value,limit:1,accept:"image/*,.pdf"},{default:s(()=>[a(xe,{class:"el-icon--upload"},{default:s(()=>[a(fe(Qe))]),_:1}),p("div",cl,[_(i(e.$t("license.upload")),1),l[15]||(l[15]=p("br",null,null,-1)),p("em",null,i(e.$t("license.noFile")),1)])]),_:1},8,["file-list"]),D.value?(d(),C("div",pl,[p("strong",null,i(e.$t("license.ocrResult"))+":",1),p("pre",null,i(D.value),1)])):M("",!0)]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(ce,{modelValue:B.value,"onUpdate:modelValue":l[13]||(l[13]=n=>B.value=n),title:e.$t("license.batchImport"),width:"600px","close-on-click-modal":!1},{footer:s(()=>[p("span",bl,[a(u,{onClick:l[12]||(l[12]=n=>B.value=!1)},{default:s(()=>[_(i(e.$t("common.cancel")),1)]),_:1}),a(u,{type:"primary",onClick:Pe,loading:A.value,disabled:!ne.value},{default:s(()=>[_(i(e.$t("license.startImport")),1)]),_:1},8,["loading","disabled"])])]),default:s(()=>[p("div",ml,[a(pe,{title:e.$t("license.importInstructions"),type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:s(()=>[p("p",null,i(e.$t("license.importFormat")),1),p("p",null,i(e.$t("license.importFields"))+": employee_id, license_type, number, expiry_date, issue_date, issuing_authority, file_name",1)]),_:1},8,["title"]),a(de,{model:h,"label-width":"120px"},{default:s(()=>[a(E,{label:e.$t("license.csvFile"),required:""},{default:s(()=>[a(J,{ref:"csvUpload","file-list":h.csvFile,"before-upload":Ie,"on-change":De,"auto-upload":!1,accept:".csv",limit:1},{tip:s(()=>[p("div",fl,i(e.$t("license.csvFileTip")),1)]),default:s(()=>[a(u,{type:"primary"},{default:s(()=>[_(i(e.$t("license.selectCsvFile")),1)]),_:1})]),_:1},8,["file-list"])]),_:1},8,["label"]),a(E,{label:e.$t("license.attachmentZip")},{default:s(()=>[a(J,{ref:"zipUpload","file-list":h.zipFile,"before-upload":Se,"on-change":Ne,"auto-upload":!1,accept:".zip",limit:1},{tip:s(()=>[p("div",_l,i(e.$t("license.zipFileTip")),1)]),default:s(()=>[a(u,null,{default:s(()=>[_(i(e.$t("license.selectZipFile")),1)]),_:1})]),_:1},8,["file-list"])]),_:1},8,["label"])]),_:1},8,["model"]),f.show?(d(),C("div",yl,[a(Re,{percentage:f.percentage,status:f.status},null,8,["percentage","status"]),p("p",null,i(f.text),1)])):M("",!0),$.value?(d(),C("div",vl,[a(pe,{type:$.value.success>0?"success":"error",closable:!1},{title:s(()=>[_(i(e.$t("license.importComplete")),1)]),default:s(()=>[p("p",null,i(e.$t("license.totalRecords"))+": "+i($.value.total),1),p("p",null,i(e.$t("license.successRecords"))+": "+i($.value.success),1),p("p",null,i(e.$t("license.failedRecords"))+": "+i($.value.failed),1)]),_:1},8,["type"]),$.value.errors&&$.value.errors.length>0?(d(),C("div",gl,[a(Ae,null,{default:s(()=>[a(Be,{title:e.$t("license.errorDetails"),name:"errors"},{default:s(()=>[a(G,{data:$.value.errors,size:"small","max-height":"300px"},{default:s(()=>[a(c,{prop:"row",label:e.$t("license.rowNumber"),width:"80"},null,8,["label"]),a(c,{prop:"employee_id",label:e.$t("license.employeeId"),width:"120"},null,8,["label"]),a(c,{prop:"error",label:e.$t("license.errorMessage")},null,8,["label"])]),_:1},8,["data"])]),_:1},8,["title"])]),_:1})])):M("",!0)])):M("",!0)])]),_:1},8,["modelValue","title"])])}}}),Tl=Je(hl,[["__scopeId","data-v-c4c0ee6e"]]);export{Tl as default};
