import{_ as ne,v as re,n as le,x as ce,y as se,z as ie,A as de,B as ue,C as he,D as _e,F as me,G as ke,H as ve,I as ge,J as fe,K as pe,e as s,g as _,L as u,t,h as n,w as c,i as g,M as b,N as L,O as ye,P as Ce,b as be,k as qe,r as m,Q as U,R as Ie,S as we,E as V,j as Me,o as r,T as Ee}from"./index-CC1QUR8I.js";import{s as Pe,c as Te}from"./qrcode-BtsK-vwo.js";import"./request-RQfx8Tvg.js";const De={name:"QRCodeCheckin",components:{ElForm:pe,ElFormItem:fe,ElInput:ge,ElButton:ve,ElAlert:ke,ElLoading:me,ElRadioGroup:_e,ElRadioButton:he,ElResult:ue,ElTag:de,ElIcon:ie,Loading:se,Camera:ce,Check:le,Warning:re},setup(){const a=qe(),p=Me(),{t:S}=be(),e=a.params.token,R=m(!0),P=m(""),k=m(null),f=m(!1),E=m(!1),F=m(""),l=m({phone_number:"",checkin_type:"in",latitude:null,longitude:null,location_accuracy:null,address:"",photo_data:null}),h=m({latitude:null,longitude:null,accuracy:null,address:""}),T=m(!1),I=m(!1),w=m(""),q=m(null),v=m(null),M=m(null),D={phone_number:[{required:!0,message:"请输入手机号码",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号码",trigger:"blur"}],checkin_type:[{required:!0,message:"请选择签到类型",trigger:"change"}]},W=U(()=>!k.value||!h.value.latitude||!h.value.longitude?null:K(k.value.center_latitude,k.value.center_longitude,h.value.latitude,h.value.longitude).toFixed(0)),G=U(()=>W.value!==null&&W.value<=k.value?.radius),H=U(()=>{const o=l.value.phone_number.length>0,d=!k.value?.require_gps||h.value.latitude&&h.value.longitude,y=!k.value?.require_photo||I.value;return o&&d&&y&&!E.value}),A=()=>{F.value=new Date().toLocaleString("zh-CN")},j=async()=>{try{R.value=!0,P.value="";const o=await Pe(e);o&&o.success&&o.data?(k.value=o.data,k.value.require_gps&&await N()):P.value=o?.message||"获取签到信息失败"}catch(o){console.error("加载二维码信息失败:",o),P.value=o.response?.data?.message||"网络错误，请稍后重试"}finally{R.value=!1}},N=()=>new Promise((o,d)=>{if(!navigator.geolocation){V.error("您的浏览器不支持位置获取"),d("不支持地理位置");return}f.value=!0;const y={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async i=>{h.value={latitude:i.coords.latitude,longitude:i.coords.longitude,accuracy:i.coords.accuracy};try{const C=await J(i.coords.latitude,i.coords.longitude);h.value.address=C}catch(C){console.warn("获取地址失败:",C),h.value.address=`${i.coords.latitude.toFixed(6)}, ${i.coords.longitude.toFixed(6)}`}l.value.latitude=i.coords.latitude,l.value.longitude=i.coords.longitude,l.value.location_accuracy=i.coords.accuracy,l.value.address=h.value.address,f.value=!1,o()},i=>{f.value=!1;let C="无法获取位置信息";switch(i.code){case i.PERMISSION_DENIED:C="位置权限被拒绝，请允许获取位置信息";break;case i.POSITION_UNAVAILABLE:C="位置信息不可用";break;case i.TIMEOUT:C="获取位置超时";break}V.error(C),d(C)},y)}),J=async(o,d)=>`纬度: ${o.toFixed(6)}, 经度: ${d.toFixed(6)}`,K=(o,d,y,i)=>{const ae=o*Math.PI/180,te=y*Math.PI/180,O=(y-o)*Math.PI/180,B=(i-d)*Math.PI/180,Q=Math.sin(O/2)*Math.sin(O/2)+Math.cos(ae)*Math.cos(te)*Math.sin(B/2)*Math.sin(B/2);return 6371e3*(2*Math.atan2(Math.sqrt(Q),Math.sqrt(1-Q)))},X=async()=>{try{M.value=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480,facingMode:"user"}}),q.value.srcObject=M.value,T.value=!0}catch(o){V.error("无法启动摄像头: "+o.message)}},z=()=>{M.value&&(M.value.getTracks().forEach(o=>o.stop()),M.value=null),T.value=!1},Y=()=>{if(!q.value||!v.value)return;const o=v.value.getContext("2d");v.value.width=q.value.videoWidth,v.value.height=q.value.videoHeight,o.drawImage(q.value,0,0),w.value=v.value.toDataURL("image/jpeg",.8),l.value.photo_data=w.value,I.value=!0,z()},Z=()=>{I.value=!1,w.value="",l.value.photo_data=null},x=async()=>{try{E.value=!0;const o={phone_number:l.value.phone_number,checkin_type:l.value.checkin_type,latitude:l.value.latitude,longitude:l.value.longitude,location_accuracy:l.value.location_accuracy,address:l.value.address,photo_data:l.value.photo_data,device_info:{device_type:$(),app_version:"1.0.0"}},d=await Te(e,o);if(d&&d.success&&d.data){const y=encodeURIComponent(JSON.stringify(d.data));p.push(`/checkin-result/${e}?result=${y}`)}else{const y=encodeURIComponent(d?.message||S("qrCheckin.checkinFailed"));p.push(`/checkin-result/${e}?error=${y}`)}}catch(o){console.error("签到失败:",o);const d=encodeURIComponent(o.response?.data?.message||S("qrCheckin.networkError"));p.push(`/checkin-result/${e}?error=${d}`)}finally{E.value=!1}},$=()=>{const o=navigator.userAgent;return/iPad|iPhone|iPod/.test(o)?"iOS":/Android/.test(o)?"Android":"Web"},ee=o=>new Date(o).toLocaleString("zh-CN"),oe=()=>{l.value={phone_number:"",checkin_type:"in",latitude:null,longitude:null,location_accuracy:null,address:"",photo_data:null},I.value=!1,w.value="",k.value?.require_gps&&N()};return Ie(()=>{j(),A();const o=setInterval(A,1e3);we(()=>{clearInterval(o),z()})}),{loading:R,error:P,qrcodeInfo:k,gpsLoading:f,submitting:E,currentTime:F,checkinData:l,locationInfo:h,cameraStarted:T,photoTaken:I,photoDataUrl:w,video:q,canvas:v,rules:D,distanceFromWorksite:W,withinWorksite:G,canSubmit:H,startCamera:X,stopCamera:z,takePhoto:Y,retakePhoto:Z,submitCheckin:x,formatTime:ee,resetForm:oe,getCurrentLocation:N}}},Re={class:"qr-checkin-container"},Fe={class:"header"},Le={key:0,class:"worksite-info"},Se={key:0},We={key:0,class:"loading"},Ne={key:1,class:"error-container"},ze={key:2,class:"checkin-form"},Ue={key:0,class:"location-section"},Ve={class:"location-info"},Ae={key:1},Oe={key:2},Be={key:3,class:"error-text"},Qe={key:0,class:"coordinates"},Ge={key:1,class:"distance-info"},He={key:1,class:"photo-section"},je={class:"camera-container"},Je={key:0,ref:"video",autoplay:"",playsinline:"",class:"camera-preview"},Ke={ref:"canvas"},Xe={key:1,class:"photo-preview"},Ye=["src"],Ze={class:"camera-controls"},xe={key:1,class:"capture-controls"},$e={key:2,class:"photo-controls"},eo={class:"submit-section"},oo={class:"time-info"},ao={key:0};function to(a,p,S,e,R,P){const k=g("Loading"),f=g("el-icon"),E=g("el-alert"),F=g("el-input"),l=g("el-form-item"),h=g("el-radio-button"),T=g("el-radio-group"),I=g("Check"),w=g("Warning"),q=g("Camera"),v=g("el-button"),M=g("el-form");return r(),s("div",Re,[_("div",Fe,[_("h1",null,t(a.$t("qrCheckin.title")),1),e.qrcodeInfo?(r(),s("div",Le,[_("h3",null,t(e.qrcodeInfo.worksite_name),1),e.qrcodeInfo.Worksite?(r(),s("p",Se,t(e.qrcodeInfo.Worksite.address),1)):u("",!0)])):u("",!0)]),e.loading?(r(),s("div",We,[n(f,{class:"is-loading",size:"large"},{default:c(()=>[n(k)]),_:1}),_("p",null,t(a.$t("qrCheckin.loading")),1)])):u("",!0),e.error?(r(),s("div",Ne,[n(E,{title:e.error,type:"error",closable:!1,center:""},null,8,["title"])])):u("",!0),!e.loading&&!e.error&&e.qrcodeInfo?(r(),s("div",ze,[n(M,{model:e.checkinData,ref:"checkinForm",rules:e.rules,"label-position":"top"},{default:c(()=>[n(l,{label:a.$t("qrCheckin.phoneNumber"),prop:"phone_number"},{default:c(()=>[n(F,{modelValue:e.checkinData.phone_number,"onUpdate:modelValue":p[0]||(p[0]=D=>e.checkinData.phone_number=D),placeholder:a.$t("qrCheckin.phonePlaceholder"),size:"large",type:"tel",maxlength:"11","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),n(l,{label:a.$t("qrCheckin.checkinType"),prop:"checkin_type"},{default:c(()=>[n(T,{modelValue:e.checkinData.checkin_type,"onUpdate:modelValue":p[1]||(p[1]=D=>e.checkinData.checkin_type=D),size:"large"},{default:c(()=>[n(h,{label:"in"},{default:c(()=>[b(t(a.$t("qrCheckin.checkinIn")),1)]),_:1}),n(h,{label:"out"},{default:c(()=>[b(t(a.$t("qrCheckin.checkinOut")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["label"]),e.qrcodeInfo.require_gps?(r(),s("div",Ue,[n(l,{label:a.$t("qrCheckin.locationInfo")},{default:c(()=>[_("div",Ve,[e.gpsLoading?(r(),L(f,{key:0},{default:c(()=>[n(k)]),_:1})):u("",!0),e.locationInfo.address?(r(),s("span",Ae,t(e.locationInfo.address),1)):e.gpsLoading?(r(),s("span",Oe,t(a.$t("qrCheckin.gettingLocation")),1)):(r(),s("span",Be,t(a.$t("qrCheckin.cannotGetLocation")),1))]),e.locationInfo.latitude&&e.locationInfo.longitude?(r(),s("div",Qe,[b(t(a.$t("qrCheckin.coordinates"))+": "+t(e.locationInfo.latitude.toFixed(6))+", "+t(e.locationInfo.longitude.toFixed(6))+" ",1),p[2]||(p[2]=_("br",null,null,-1)),b(" "+t(a.$t("qrCheckin.accuracy"))+": "+t(e.locationInfo.accuracy?`${e.locationInfo.accuracy}${a.$t("qrCheckin.meters")}`:a.$t("qrCheckin.unknown")),1)])):u("",!0),e.distanceFromWorksite!==null?(r(),s("div",Ge,[_("span",{class:ye(e.withinWorksite?"success-text":"warning-text")},[b(t(a.$t("qrCheckin.distanceFromWorksite"))+": "+t(e.distanceFromWorksite)+t(a.$t("qrCheckin.meters"))+" ",1),e.withinWorksite?(r(),L(f,{key:0,class:"success-text"},{default:c(()=>[n(I)]),_:1})):(r(),L(f,{key:1,class:"warning-text"},{default:c(()=>[n(w)]),_:1}))],2)])):u("",!0)]),_:1},8,["label"])])):u("",!0),e.qrcodeInfo.require_photo?(r(),s("div",He,[n(l,{label:a.$t("qrCheckin.photoVerification"),prop:"photo_data"},{default:c(()=>[_("div",je,[e.photoTaken?u("",!0):(r(),s("video",Je,null,512)),Ce(_("canvas",Ke,null,512),[[Ee,!1]]),e.photoTaken?(r(),s("div",Xe,[_("img",{src:e.photoDataUrl,alt:"签到照片"},null,8,Ye)])):u("",!0),_("div",Ze,[!e.cameraStarted&&!e.photoTaken?(r(),L(v,{key:0,onClick:e.startCamera,type:"primary",size:"large"},{default:c(()=>[n(f,null,{default:c(()=>[n(q)]),_:1}),b(" "+t(a.$t("qrCheckin.startCamera")),1)]),_:1},8,["onClick"])):u("",!0),e.cameraStarted&&!e.photoTaken?(r(),s("div",xe,[n(v,{onClick:e.takePhoto,type:"success",size:"large"},{default:c(()=>[n(f,null,{default:c(()=>[n(q)]),_:1}),b(" "+t(a.$t("qrCheckin.takePhoto")),1)]),_:1},8,["onClick"]),n(v,{onClick:e.stopCamera,type:"info",size:"large"},{default:c(()=>[b(t(a.$t("qrCheckin.stopCamera")),1)]),_:1},8,["onClick"])])):u("",!0),e.photoTaken?(r(),s("div",$e,[n(v,{onClick:e.retakePhoto,type:"warning",size:"large"},{default:c(()=>[b(t(a.$t("qrCheckin.retakePhoto")),1)]),_:1},8,["onClick"])])):u("",!0)])])]),_:1},8,["label"])])):u("",!0),_("div",eo,[n(v,{onClick:e.submitCheckin,type:"primary",size:"large",loading:e.submitting,disabled:!e.canSubmit,class:"submit-button"},{default:c(()=>[b(t(e.submitting?a.$t("qrCheckin.submitting"):a.$t("qrCheckin.submit")),1)]),_:1},8,["onClick","loading","disabled"])]),_("div",oo,[_("p",null,t(a.$t("common.currentTime",{time:e.currentTime})),1),!e.qrcodeInfo.allow_checkin_anytime&&e.qrcodeInfo.work_start_time&&e.qrcodeInfo.work_end_time?(r(),s("p",ao,t(a.$t("common.workTime",{start:e.qrcodeInfo.work_start_time,end:e.qrcodeInfo.work_end_time})),1)):u("",!0)])]),_:1},8,["model","rules"])])):u("",!0)])}const so=ne(De,[["render",to],["__scopeId","data-v-636aab73"]]);export{so as default};
