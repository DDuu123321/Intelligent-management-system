import{d as ue,b as pe,ad as fe,r as f,c as me,Q as _e,R as ye,e as ge,g as i,h as t,t as a,w as l,i as s,E as m,M as d,P as we,a7 as ve,N as b,L as E,l as N,v as he,O as be,a0 as Ce,a9 as R,o as h,_ as $e}from"./index-CC1QUR8I.js";import{i as ke,j as A,k as D}from"./licenses-BWMabNXL.js";import"./request-RQfx8Tvg.js";const xe={class:"ocr-confirmation"},Se={class:"page-header"},Ve={class:"actions"},ze={class:"card-header"},Ee={class:"employee-info"},Re={class:"parsed-expiry-cell"},Oe={class:"confidence-cell"},je={class:"ocr-text-preview"},Le={class:"ocr-raw-text"},Te={style:{"margin-top":"20px","text-align":"right"}},Me=ue({__name:"LicenseOcrConfirmation",setup(Pe){const{locale:F,t:r}=pe();fe();const C=f(!1),$=f(!1),k=f([]),_=f([]),x=f(!1),S=f(1),V=f(10),z=f(0),w=f(!1),g=f(null),u=me({expiry_date:"",notes:""}),O=_e(()=>_.value.length>0);function j(e){return e?(F.value||"").startsWith("zh")&&e.name_zh||e.name_en:""}function U(e){return e>=.8?"success":e>=.6?"warning":"danger"}function B(e){switch(e){case"parsed":return"success";case"low_confidence":return"warning";case"confirmed":return"success";case"rejected":return"danger";default:return"info"}}function W(e){return r(`license.ocrStatus.${e}`)}function q({row:e}){return e.parse_confidence<.5?"very-low-confidence-row":e.parse_confidence<.7?"low-confidence-row":""}function I(e){return e.parsed_expiry_date?e.parse_confidence<.6||e.parse_confidence<.8?"text-warning":"text-success":"text-gray"}function Z(e){return e>=.8?"#67c23a":e>=.6?"#e6a23c":"#f56c6c"}async function y(){C.value=!0;try{const e=await ke({page:S.value,limit:V.value});k.value=e.data.licenses,z.value=e.data.total}catch(e){console.error("加载待确认OCR记录失败:",e),m.error(r("license.loadOcrFailed"))}finally{C.value=!1}}function Q(e){_.value=e,x.value=e.length===k.value.length}function G(){}async function L(e,o){try{const c=r(o==="confirm"?"license.confirm":"license.reject");await R.confirm(r("license.confirmOcrAction",{action:c}),r("common.confirm"),{type:"warning"}),await A(e.employee_license_id,{action:o}),m.success(r("license.ocrActionSuccess",{action:c})),y()}catch(c){if(c==="cancel")return;console.error("OCR确认失败:",c),m.error(r("license.ocrActionFailed"))}}function H(e){g.value=e,u.expiry_date=e.parsed_expiry_date||e.expiry_date,u.notes="",w.value=!0}async function J(){if(!u.expiry_date){m.error(r("license.expiryDateRequired"));return}$.value=!0;try{await A(g.value.employee_license_id,{action:"modify",expiry_date:u.expiry_date,notes:u.notes}),m.success(r("license.modifySuccess")),w.value=!1,y()}catch(e){console.error("修改到期日期失败:",e),m.error(r("license.modifyFailed"))}finally{$.value=!1}}async function K(){if(_.value.length!==0)try{await R.confirm(r("license.batchConfirmWarning",{count:_.value.length}),r("common.confirm"),{type:"warning"});const e=_.value.map(o=>({id:o.employee_license_id,action:"confirm"}));await D(e),m.success(r("license.batchConfirmSuccess")),y()}catch(e){if(e==="cancel")return;console.error("批量确认失败:",e),m.error(r("license.batchConfirmFailed"))}}async function X(){if(_.value.length!==0)try{await R.confirm(r("license.batchRejectWarning",{count:_.value.length}),r("common.confirm"),{type:"warning"});const e=_.value.map(o=>({id:o.employee_license_id,action:"reject"}));await D(e),m.success(r("license.batchRejectSuccess")),y()}catch(e){if(e==="cancel")return;console.error("批量拒绝失败:",e),m.error(r("license.batchRejectFailed"))}}return ye(()=>{y()}),(e,o)=>{const c=s("el-button"),Y=s("el-checkbox"),p=s("el-table-column"),T=s("el-icon"),ee=s("el-tooltip"),M=s("el-tag"),ne=s("el-progress"),te=s("el-popover"),le=s("el-table"),ae=s("el-pagination"),oe=s("el-card"),v=s("el-form-item"),re=s("el-date-picker"),ie=s("el-input"),se=s("el-form"),ce=s("el-dialog"),de=ve("loading");return h(),ge("div",xe,[i("div",Se,[i("h2",null,a(e.$t("license.ocrConfirmation")),1),i("div",Ve,[t(c,{type:"success",disabled:!O.value,onClick:K},{default:l(()=>[d(a(e.$t("license.batchConfirm")),1)]),_:1},8,["disabled"]),t(c,{type:"warning",disabled:!O.value,onClick:X},{default:l(()=>[d(a(e.$t("license.batchReject")),1)]),_:1},8,["disabled"]),t(c,{onClick:y},{default:l(()=>[d(a(e.$t("common.refresh")),1)]),_:1})])]),t(oe,null,{header:l(()=>[i("div",ze,[i("span",null,a(e.$t("license.pendingOcrRecords"))+" ("+a(z.value)+")",1),t(Y,{modelValue:x.value,"onUpdate:modelValue":o[0]||(o[0]=n=>x.value=n),onChange:G},{default:l(()=>[d(a(e.$t("common.selectAll")),1)]),_:1},8,["modelValue"])])]),default:l(()=>[o[7]||(o[7]=d()),we((h(),b(le,{data:k.value,onSelectionChange:Q,style:{width:"100%"},"row-class-name":q},{default:l(()=>[t(p,{type:"selection",width:"55"}),t(p,{prop:"employee_name",label:e.$t("license.employee"),width:"140"},{default:l(n=>[i("div",Ee,[i("span",null,a(n.row.Employee?.first_name)+" "+a(n.row.Employee?.last_name),1),n.row.parse_confidence<.5?(h(),b(T,{key:0,class:"low-confidence-icon",color:"#f56c6c"},{default:l(()=>[t(N(he))]),_:1})):E("",!0)])]),_:1},8,["label"]),t(p,{prop:"license_type",label:e.$t("license.type"),width:"180"},{default:l(n=>[d(a(j(n.row.LicenseType)),1)]),_:1},8,["label"]),t(p,{prop:"number",label:e.$t("license.number"),width:"150"},null,8,["label"]),t(p,{prop:"current_expiry",label:e.$t("license.currentExpiry"),width:"120"},{default:l(n=>[d(a(n.row.expiry_date),1)]),_:1},8,["label"]),t(p,{prop:"parsed_expiry",label:e.$t("license.parsedExpiry"),width:"120"},{default:l(n=>[i("div",Re,[i("span",{class:be(I(n.row))},a(n.row.parsed_expiry_date||"--"),3),n.row.parse_confidence<.6?(h(),b(ee,{key:0,content:e.$t("license.lowConfidenceWarning"),placement:"top"},{default:l(()=>[t(T,{class:"confidence-warning-icon",color:"#e6a23c"},{default:l(()=>[t(N(Ce))]),_:1})]),_:1},8,["content"])):E("",!0)])]),_:1},8,["label"]),t(p,{prop:"confidence",label:e.$t("license.confidence"),width:"100"},{default:l(n=>[i("div",Oe,[t(M,{type:U(n.row.parse_confidence),size:"small"},{default:l(()=>[d(a(Math.round((n.row.parse_confidence||0)*100))+"% ",1)]),_:2},1032,["type"]),n.row.parse_confidence!==null?(h(),b(ne,{key:0,percentage:Math.round((n.row.parse_confidence||0)*100),"stroke-width":4,"show-text":!1,color:Z(n.row.parse_confidence),style:{"margin-top":"4px"}},null,8,["percentage","color"])):E("",!0)])]),_:1},8,["label"]),t(p,{prop:"ocr_status",label:e.$t("license.ocrStatus"),width:"120"},{default:l(n=>[t(M,{type:B(n.row.ocr_status),size:"small"},{default:l(()=>[d(a(W(n.row.ocr_status)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),t(p,{label:e.$t("license.ocrPreview"),width:"200"},{default:l(n=>[t(te,{placement:"left",width:400,trigger:"click"},{reference:l(()=>[t(c,{size:"small",type:"info"},{default:l(()=>[d(a(e.$t("license.viewOcrText")),1)]),_:1})]),default:l(()=>[i("div",je,[i("strong",null,a(e.$t("license.ocrRawText"))+":",1),i("pre",Le,a(n.row.ocr_raw_text||e.$t("license.noOcrText")),1)])]),_:2},1024)]),_:1},8,["label"]),t(p,{label:e.$t("common.actions"),width:"300",fixed:"right"},{default:l(n=>[t(c,{size:"small",type:"success",onClick:P=>L(n.row,"confirm")},{default:l(()=>[d(a(e.$t("license.confirm")),1)]),_:2},1032,["onClick"]),t(c,{size:"small",type:"warning",onClick:P=>H(n.row)},{default:l(()=>[d(a(e.$t("license.modify")),1)]),_:2},1032,["onClick"]),t(c,{size:"small",type:"danger",onClick:P=>L(n.row,"reject")},{default:l(()=>[d(a(e.$t("license.reject")),1)]),_:2},1032,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[de,C.value]]),i("div",Te,[t(ae,{"current-page":S.value,"onUpdate:currentPage":o[1]||(o[1]=n=>S.value=n),"page-size":V.value,"onUpdate:pageSize":o[2]||(o[2]=n=>V.value=n),"page-sizes":[10,20,50],total:z.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:y,onCurrentChange:y},null,8,["current-page","page-size","total"])])]),_:1}),t(ce,{modelValue:w.value,"onUpdate:modelValue":o[6]||(o[6]=n=>w.value=n),title:e.$t("license.modifyExpiry"),width:"400px"},{footer:l(()=>[t(c,{onClick:o[5]||(o[5]=n=>w.value=!1)},{default:l(()=>[d(a(e.$t("common.cancel")),1)]),_:1}),t(c,{type:"primary",onClick:J,loading:$.value},{default:l(()=>[d(a(e.$t("common.confirm")),1)]),_:1},8,["loading"])]),default:l(()=>[t(se,{model:u,"label-width":"120px"},{default:l(()=>[t(v,{label:e.$t("license.employee")},{default:l(()=>[i("span",null,a(g.value?.Employee?.first_name)+" "+a(g.value?.Employee?.last_name),1)]),_:1},8,["label"]),t(v,{label:e.$t("license.type")},{default:l(()=>[i("span",null,a(j(g.value?.LicenseType)),1)]),_:1},8,["label"]),t(v,{label:e.$t("license.parsedExpiry")},{default:l(()=>[i("span",null,a(g.value?.parsed_expiry_date||"--"),1)]),_:1},8,["label"]),t(v,{label:e.$t("license.newExpiry"),required:""},{default:l(()=>[t(re,{modelValue:u.expiry_date,"onUpdate:modelValue":o[3]||(o[3]=n=>u.expiry_date=n),type:"date",style:{width:"100%"}},null,8,["modelValue"])]),_:1},8,["label"]),t(v,{label:e.$t("license.notes")},{default:l(()=>[t(ie,{modelValue:u.notes,"onUpdate:modelValue":o[4]||(o[4]=n=>u.notes=n),type:"textarea",rows:3,placeholder:e.$t("license.modifyReason")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),Fe=$e(Me,[["__scopeId","data-v-394ab41e"]]);export{Fe as default};
