import{d as x,b as tt,u as st,r as R,c as O,a1 as et,Q as at,R as nt,e as lt,g as t,h as n,t as e,O as A,w as l,i as f,E as Z,l as g,p as ot,a2 as G,a3 as it,a4 as dt,a5 as rt,v as ct,a6 as ut,P as V,a7 as pt,N as M,M as r,q as ht,o as q,_ as mt}from"./index-CC1QUR8I.js";import{r as B}from"./request-RQfx8Tvg.js";import{g as vt,e as gt}from"./licenses-BWMabNXL.js";class ft{cache=new Map;throttle=new Map;defaultTTL=3e4;defaultThrottle=1e3;getCacheKey(o,i){const h=i?JSON.stringify(i):"";return`${o}:${h}`}get(o,i){const h=this.getCacheKey(o,i),p=this.cache.get(h);return p?Date.now()>p.expiry?(this.cache.delete(h),null):p.data:null}set(o,i,h,p){const c=this.getCacheKey(o,p),b=h||this.defaultTTL;this.cache.set(c,{data:i,timestamp:Date.now(),expiry:Date.now()+b})}clear(o){if(!o){this.cache.clear();return}for(const i of this.cache.keys())i.includes(o)&&this.cache.delete(i)}shouldThrottle(o,i){const h=i||this.defaultThrottle,p=this.throttle.get(o);return p?Date.now()-p.lastRequest<p.delay?!0:(p.lastRequest=Date.now(),!1):(this.throttle.set(o,{lastRequest:Date.now(),delay:h}),!1)}async waitForThrottle(o,i){i||this.defaultThrottle;const h=this.throttle.get(o);if(!h)return;const p=Date.now()-h.lastRequest,c=h.delay-p;c>0&&(console.log(`⏳ 请求节流: 等待 ${c}ms 后请求 ${o}`),await new Promise(b=>setTimeout(b,c)))}}const _=new ft,I={STATS:3e4},j={STATS:2e3},_t=async()=>{const u="/attendance/stats",o=_.get(u);if(o)return console.log("📋 使用缓存数据: attendance/stats"),o;await _.waitForThrottle(u,j.STATS);const i=await B.get(u);return _.set(u,i,I.STATS),i},bt=async()=>{const u="/vehicles/stats",o=_.get(u);if(o)return console.log("📋 使用缓存数据: vehicles/stats"),o;await _.waitForThrottle(u,j.STATS);const i=await B.get(u);return _.set(u,i,I.STATS),i},wt=async()=>{const u="/monitoring/stats",o=_.get(u);if(o)return console.log("📋 使用缓存数据: monitoring/stats"),o;await _.waitForThrottle(u,j.STATS);const i=await B.get(u);return _.set(u,i,I.STATS),i},yt={class:"dashboard"},$t={class:"stats-grid"},St={class:"stats-content"},Tt={class:"stats-icon stats-icon-primary"},Ct={class:"stats-info"},kt={class:"stats-number"},Lt={class:"stats-label"},Rt={class:"stats-trend"},zt={class:"stats-content"},Dt={class:"stats-icon stats-icon-success"},At={class:"stats-info"},qt={class:"stats-number"},Et={class:"stats-label"},Ut={class:"stats-trend"},Ft={class:"stats-content"},Nt={class:"stats-icon stats-icon-warning"},Ot={class:"stats-info"},Vt={class:"stats-number"},Mt={class:"stats-label"},Bt={class:"stats-trend"},It={class:"stats-content"},jt={class:"stats-icon stats-icon-danger"},Kt={class:"stats-info"},Pt={class:"stats-number"},Zt={class:"stats-label"},Gt={class:"stats-trend"},Ht={class:"card-header"},Wt={class:"quick-stats"},Jt={class:"stat-item"},Qt={class:"stat-item"},Xt={class:"stat-item"},Yt={class:"stat-item"},xt={class:"quick-stats"},ts={class:"stat-item"},ss={class:"stat-item"},es={class:"stat-item"},as={class:"stat-item"},ns={class:"quick-stats"},ls={class:"stat-item"},os={class:"stat-item"},is={class:"stat-item"},ds={class:"stat-item"},rs={class:"system-status"},cs={class:"status-item"},us={class:"status-label"},ps={class:"status-item"},hs={class:"status-label"},ms={class:"status-value"},vs={class:"status-item"},gs={class:"status-label"},fs={class:"status-value"},_s={class:"status-item"},bs={class:"status-label"},ws={class:"card-header"},ys=x({__name:"Dashboard",setup(u){const{t:o,locale:i}=tt(),p=st().user,c=R(!1),b=R(!0),K=R(""),S=O({present:0,late:0,absent:0,leave:0}),y=O({running:0,idle:0,maintenance:0,offline:0}),$=O({online:0,recording:0,alert:0,offline:0}),E=async()=>{try{c.value=!0,b.value=!0;const[s,a,d]=await Promise.all([_t(),bt(),wt()]);Object.assign(S,s.data),Object.assign(y,a.data),Object.assign($,d.data),P(),Z.success(o("dashboard.dataFetchSuccess"))}catch{b.value=!1,Z.error(o("dashboard.dataFetchFailed"))}finally{c.value=!1}},H=()=>{E()},P=()=>{const s=i.value==="en-US"?"en-US":"zh-CN";K.value=new Date().toLocaleString(s)};et(i,()=>{P()});const U=R([]),C=R(""),k=async()=>{try{const s=await vt({within:60}),a=(i.value||"").startsWith("zh");U.value=(s.data||[]).map(d=>{const w=d.days_remaining;let m="";d.status==="expired"?m="danger":d.status==="expiring"?m=w<=7?"danger":w<=14?"warning":"info":m="success";const v=a?d.license?.name_zh||d.license?.name_en:d.license?.name_en||d.license?.name_zh,L=d.status==="expired"?o("license.expired"):d.status==="expiring"?o("license.expiringSoon"):o("license.normal");return{...d,licenseName:v,statusTag:m,statusLabel:L}})}catch{}},W=at(()=>C.value?U.value.filter(s=>(s.name||"").toLowerCase().includes(C.value.toLowerCase())||(s.license?.code||"").toLowerCase().includes(C.value.toLowerCase())):U.value),J=({row:s})=>s.status==="expired"?"row-expired":s.status==="expiring"?"row-expiring":"",Q=async()=>{const a=(i.value||"").startsWith("zh")?"zh":"en",d=await gt(60,a),w=d instanceof Blob?d:new Blob([d],{type:"text/csv;charset=utf-8;"}),m=window.URL.createObjectURL(w),v=document.createElement("a");v.href=m,v.download="licenses_expiring.csv",v.click(),window.URL.revokeObjectURL(m)},z=s=>{const a=s.currentTarget;a.style.transform="scale(0.95)",setTimeout(()=>{a.style.transform="scale(1)"},150)};return nt(()=>{E(),setInterval(E,3e4),k(),setInterval(k,6e4)}),(s,a)=>{const d=f("el-icon"),w=f("el-button"),m=f("el-card"),v=f("el-col"),L=f("el-row"),F=f("el-tag"),X=f("el-input"),T=f("el-table-column"),Y=f("el-table"),N=pt("loading");return q(),lt("div",yt,[t("h1",null,e(s.$t("dashboard.title")),1),t("div",$t,[t("div",{class:A(["stats-card",{loading:c.value}]),onClick:z},[t("div",St,[t("div",Tt,[n(d,{size:"48"},{default:l(()=>[n(g(ot))]),_:1})]),t("div",Ct,[t("div",kt,e(S.present),1),t("div",Lt,e(s.$t("dashboard.onlineEmployees")),1)]),t("div",Rt,[n(d,{color:"#67C23A"},{default:l(()=>[n(g(G))]),_:1}),a[1]||(a[1]=t("span",{class:"trend-text"},"+12%",-1))])]),a[2]||(a[2]=t("div",{class:"stats-background"},null,-1))],2),t("div",{class:A(["stats-card",{loading:c.value}]),onClick:z},[t("div",zt,[t("div",Dt,[n(d,{size:"48"},{default:l(()=>[n(g(it))]),_:1})]),t("div",At,[t("div",qt,e(y.running+y.idle),1),t("div",Et,e(s.$t("dashboard.runningVehicles")),1)]),t("div",Ut,[n(d,{color:"#67C23A"},{default:l(()=>[n(g(G))]),_:1}),a[3]||(a[3]=t("span",{class:"trend-text"},"+8%",-1))])]),a[4]||(a[4]=t("div",{class:"stats-background"},null,-1))],2),t("div",{class:A(["stats-card",{loading:c.value}]),onClick:z},[t("div",Ft,[t("div",Nt,[n(d,{size:"48"},{default:l(()=>[n(g(dt))]),_:1})]),t("div",Ot,[t("div",Vt,e($.online),1),t("div",Mt,e(s.$t("dashboard.recordingCameras")),1)]),t("div",Bt,[n(d,{color:"#E6A23C"},{default:l(()=>[n(g(rt))]),_:1}),a[5]||(a[5]=t("span",{class:"trend-text"},"-2%",-1))])]),a[6]||(a[6]=t("div",{class:"stats-background"},null,-1))],2),t("div",{class:A(["stats-card",{loading:c.value}]),onClick:z},[t("div",It,[t("div",jt,[n(d,{size:"48"},{default:l(()=>[n(g(ct))]),_:1})]),t("div",Kt,[t("div",Pt,e($.alert),1),t("div",Zt,e(s.$t("dashboard.alertMessages")),1)]),t("div",Gt,[n(d,{color:"#F56C6C"},{default:l(()=>[n(g(ut))]),_:1}),a[7]||(a[7]=t("span",{class:"trend-text"},"-15%",-1))])]),a[8]||(a[8]=t("div",{class:"stats-background"},null,-1))],2)]),n(L,{gutter:20,style:{"margin-top":"20px"}},{default:l(()=>[n(v,{span:8},{default:l(()=>[V((q(),M(m,null,{header:l(()=>[t("div",Ht,[t("span",null,e(s.$t("dashboard.attendanceStats")),1),n(w,{type:"primary",size:"small",onClick:H,loading:c.value},{default:l(()=>[r(e(s.$t("common.refresh")),1)]),_:1},8,["loading"])])]),default:l(()=>[t("div",Wt,[t("div",Jt,[a[9]||(a[9]=t("span",{class:"stat-dot present"},null,-1)),t("span",null,[r(e(s.$t("status.present"))+": ",1),t("strong",null,e(S.present)+e(s.$t("units.person")),1)])]),t("div",Qt,[a[10]||(a[10]=t("span",{class:"stat-dot late"},null,-1)),t("span",null,[r(e(s.$t("status.late"))+": ",1),t("strong",null,e(S.late)+e(s.$t("units.person")),1)])]),t("div",Xt,[a[11]||(a[11]=t("span",{class:"stat-dot absent"},null,-1)),t("span",null,[r(e(s.$t("status.absent"))+": ",1),t("strong",null,e(S.absent)+e(s.$t("units.person")),1)])]),t("div",Yt,[a[12]||(a[12]=t("span",{class:"stat-dot leave"},null,-1)),t("span",null,[r(e(s.$t("status.leave"))+": ",1),t("strong",null,e(S.leave)+e(s.$t("units.person")),1)])])])]),_:1})),[[N,c.value]])]),_:1}),n(v,{span:8},{default:l(()=>[V((q(),M(m,null,{header:l(()=>[t("span",null,e(s.$t("dashboard.vehicleStats")),1)]),default:l(()=>[t("div",xt,[t("div",ts,[a[13]||(a[13]=t("span",{class:"stat-dot running"},null,-1)),t("span",null,[r(e(s.$t("status.running"))+": ",1),t("strong",null,e(y.running)+e(s.$t("units.vehicle")),1)])]),t("div",ss,[a[14]||(a[14]=t("span",{class:"stat-dot idle"},null,-1)),t("span",null,[r(e(s.$t("status.idle"))+": ",1),t("strong",null,e(y.idle)+e(s.$t("units.vehicle")),1)])]),t("div",es,[a[15]||(a[15]=t("span",{class:"stat-dot maintenance"},null,-1)),t("span",null,[r(e(s.$t("status.maintenance"))+": ",1),t("strong",null,e(y.maintenance)+e(s.$t("units.vehicle")),1)])]),t("div",as,[a[16]||(a[16]=t("span",{class:"stat-dot offline"},null,-1)),t("span",null,[r(e(s.$t("status.offline"))+": ",1),t("strong",null,e(y.offline)+e(s.$t("units.vehicle")),1)])])])]),_:1})),[[N,c.value]])]),_:1}),n(v,{span:8},{default:l(()=>[V((q(),M(m,null,{header:l(()=>[t("span",null,e(s.$t("dashboard.monitorStats")),1)]),default:l(()=>[t("div",ns,[t("div",ls,[a[17]||(a[17]=t("span",{class:"stat-dot online"},null,-1)),t("span",null,[r(e(s.$t("status.online"))+": ",1),t("strong",null,e($.online)+e(s.$t("units.device")),1)])]),t("div",os,[a[18]||(a[18]=t("span",{class:"stat-dot recording"},null,-1)),t("span",null,[r(e(s.$t("status.recording"))+": ",1),t("strong",null,e($.recording)+e(s.$t("units.device")),1)])]),t("div",is,[a[19]||(a[19]=t("span",{class:"stat-dot offline"},null,-1)),t("span",null,[r(e(s.$t("status.offline"))+": ",1),t("strong",null,e($.offline)+e(s.$t("units.device")),1)])]),t("div",ds,[a[20]||(a[20]=t("span",{class:"stat-dot alert"},null,-1)),t("span",null,[r(e(s.$t("status.alert"))+": ",1),t("strong",null,e($.alert)+e(s.$t("units.alert")),1)])])])]),_:1})),[[N,c.value]])]),_:1})]),_:1}),n(L,{gutter:20,style:{"margin-top":"20px"}},{default:l(()=>[n(v,{span:24},{default:l(()=>[n(m,null,{header:l(()=>[t("span",null,e(s.$t("dashboard.systemStatus")),1)]),default:l(()=>[t("div",rs,[t("div",cs,[t("span",us,e(s.$t("dashboard.apiStatus"))+":",1),n(F,{type:b.value?"success":"danger"},{default:l(()=>[r(e(b.value?s.$t("status.normal"):s.$t("status.disconnect")),1)]),_:1},8,["type"])]),t("div",ps,[t("span",hs,e(s.$t("dashboard.dataUpdateTime"))+":",1),t("span",ms,e(K.value),1)]),t("div",vs,[t("span",gs,e(s.$t("dashboard.currentUser"))+":",1),t("span",fs,e(g(p)?.name||s.$t("common.unknown"))+" ("+e(g(p)?.role||s.$t("common.unknown"))+")",1)]),t("div",_s,[t("span",bs,e(s.$t("dashboard.systemRunning"))+":",1),n(F,{type:"success"},{default:l(()=>[r(e(s.$t("dashboard.normalRunning")),1)]),_:1})])])]),_:1})]),_:1})]),_:1}),n(L,{gutter:20,style:{"margin-top":"20px"}},{default:l(()=>[n(v,{span:24},{default:l(()=>[n(m,null,{header:l(()=>[t("div",ws,[t("span",null,e(s.$t("license.widgetTitle")),1),t("div",null,[n(X,{modelValue:C.value,"onUpdate:modelValue":a[0]||(a[0]=D=>C.value=D),placeholder:s.$t("license.searchPlaceholder"),size:"small",style:{width:"220px","margin-right":"8px"},clearable:"",onClear:k,onKeyup:ht(k,["enter"])},null,8,["modelValue","placeholder"]),n(w,{size:"small",onClick:k},{default:l(()=>[r(e(s.$t("license.refresh")),1)]),_:1}),n(w,{size:"small",type:"primary",onClick:Q},{default:l(()=>[r(e(s.$t("license.exportCsv")),1)]),_:1})])])]),default:l(()=>[n(Y,{data:W.value,size:"small","row-class-name":J,style:{width:"100%"}},{default:l(()=>[n(T,{prop:"name",label:s.$t("license.employee"),width:"160"},null,8,["label"]),n(T,{prop:"licenseName",label:s.$t("license.type"),width:"200"},null,8,["label"]),n(T,{prop:"number",label:s.$t("license.number"),width:"160"},null,8,["label"]),n(T,{prop:"expiry_date",label:s.$t("license.expiryDate"),width:"130"},null,8,["label"]),n(T,{prop:"days_remaining",label:s.$t("license.daysRemaining"),width:"120"},null,8,["label"]),n(T,{prop:"statusLabel",label:s.$t("license.status"),width:"120"},{default:l(D=>[n(F,{type:D.row.statusTag},{default:l(()=>[r(e(D.row.statusLabel),1)]),_:2},1032,["type"])]),_:1},8,["label"])]),_:1},8,["data"])]),_:1})]),_:1})]),_:1})])}}}),Cs=mt(ys,[["__scopeId","data-v-5a139ae7"]]);export{Cs as default};
