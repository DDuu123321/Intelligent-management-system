import{d as re,b as ue,ad as ce,r as w,c as E,R as de,e as x,g as m,h as t,t as r,w as n,i as s,E as L,M as d,ac as pe,l as me,af as fe,aa as R,ab as B,P as j,a7 as F,N as v,O as _e,L as ge,j as be,o as f,_ as he}from"./index-CC1QUR8I.js";import{a as ye,g as we,e as ve}from"./licenses-BWMabNXL.js";import"./request-RQfx8Tvg.js";const Ce={class:"expiring-licenses"},$e={class:"page-header"},xe={class:"actions"},Se={class:"card-header"},ke={key:1,style:{color:"#bbb"}},Ve={style:{"margin-top":"20px","text-align":"right"}},Ee=re({__name:"ExpiringLicenses",setup(Le){const{locale:T,t:g}=ue(),z=be();ce();const S=w(!1),k=w(!1),C=w([]),I=w([]),$=w(0),o=E({within:30,includeExpired:!0,search:"",licenseTypeId:null,status:""}),p=E({page:1,limit:20}),h=E({sortBy:"expiry_date",sortOrder:"ASC"});function O(e){return e?(T.value||"").startsWith("zh")&&e.name_zh||e.name_en:""}function M(e){return e<0||e<=7?"text-danger":e<=14?"text-warning":""}function P(e){switch(e){case"expired":return"danger";case"expiring":return"warning";case"normal":return"success";default:return"info"}}function A(e){switch(e){case"expired":return g("license.expired");case"expiring":return g("license.expiringSoon");case"normal":return g("license.normal");default:return e}}function W(e){switch(e){case"confirmed":return"success";case"parsed":return"success";case"low_confidence":return"warning";case"rejected":return"danger";default:return"info"}}function Z(e){return g(`license.ocrStatus.${e}`)}async function q(){try{const e=await ye();I.value=e.data}catch(e){console.error("åŠ è½½è¯ä»¶ç±»åž‹å¤±è´¥:",e)}}async function i(){S.value=!0;try{const e={...o,...p,...h,includeExpired:o.includeExpired,licenseTypeId:o.licenseTypeId||void 0},a=await we(e);a.data.licenses?(C.value=a.data.licenses,$.value=a.data.pagination?.total||0):(C.value=a.data||[],$.value=C.value.length)}catch(e){console.error("åŠ è½½åˆ°æœŸè¯ä»¶å¤±è´¥:",e),L.error(g("license.loadFailed"))}finally{S.value=!1}}function G({prop:e,order:a}){a?(h.sortBy=e==="name"?"employee_name":e==="licenseName"?"license_type":e,h.sortOrder=a==="ascending"?"ASC":"DESC"):(h.sortBy="expiry_date",h.sortOrder="ASC"),p.page=1,i()}function H(){Object.assign(o,{within:30,includeExpired:!0,search:"",licenseTypeId:null,status:""}),p.page=1,i()}async function J(){k.value=!0;try{const e=T.value?.startsWith("zh")?"zh":"en",a=await ve(o.within,e),u=window.URL.createObjectURL(a),_=document.createElement("a");_.style.display="none",_.href=u,_.download=`expiring_licenses_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(_),_.click(),window.URL.revokeObjectURL(u),document.body.removeChild(_),L.success(g("license.exportSuccess"))}catch(e){console.error("å¯¼å‡ºå¤±è´¥:",e),L.error(g("license.exportFailed"))}finally{k.value=!1}}function K(e){e&&window.open(e,"_blank")}function Q(e){z.push({path:"/licenses",query:{employeeId:e.employee_id,highlightId:e.id}})}function X(e){z.push("/admin/licenses/ocr-confirmation")}return de(()=>{q(),i()}),(e,a)=>{const u=s("el-button"),_=s("el-input-number"),b=s("el-form-item"),Y=s("el-switch"),ee=s("el-icon"),le=s("el-input"),y=s("el-option"),V=s("el-select"),te=s("el-form"),U=s("el-card"),c=s("el-table-column"),D=s("el-tag"),ne=s("el-tooltip"),ae=s("el-table"),oe=s("el-pagination"),se=F("permission"),ie=F("loading");return f(),x("div",Ce,[m("div",$e,[m("h2",null,r(e.$t("license.widgetTitle")),1),m("div",xe,[t(u,{onClick:J,loading:k.value},{default:n(()=>[d(r(e.$t("license.exportCsv")),1)]),_:1},8,["loading"]),t(u,{onClick:i},{default:n(()=>[d(r(e.$t("common.refresh")),1)]),_:1})])]),t(U,{class:"filter-card",style:{"margin-bottom":"20px"}},{header:n(()=>[m("span",null,r(e.$t("common.filters")),1)]),default:n(()=>[t(te,{model:o,inline:!0,onSubmit:pe(i,["prevent"])},{default:n(()=>[t(b,{label:e.$t("license.daysWithin")},{default:n(()=>[t(_,{modelValue:o.within,"onUpdate:modelValue":a[0]||(a[0]=l=>o.within=l),min:1,max:365,style:{width:"120px"},onChange:i},null,8,["modelValue"])]),_:1},8,["label"]),t(b,{label:e.$t("license.includeExpired")},{default:n(()=>[t(Y,{modelValue:o.includeExpired,"onUpdate:modelValue":a[1]||(a[1]=l=>o.includeExpired=l),onChange:i},null,8,["modelValue"])]),_:1},8,["label"]),t(b,{label:e.$t("common.search")},{default:n(()=>[t(le,{modelValue:o.search,"onUpdate:modelValue":a[2]||(a[2]=l=>o.search=l),placeholder:e.$t("license.searchPlaceholder"),clearable:"",style:{width:"200px"},onChange:i},{prefix:n(()=>[t(ee,null,{default:n(()=>[t(me(fe))]),_:1})]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),t(b,{label:e.$t("license.type")},{default:n(()=>[t(V,{modelValue:o.licenseTypeId,"onUpdate:modelValue":a[3]||(a[3]=l=>o.licenseTypeId=l),placeholder:e.$t("license.filterType"),clearable:"",style:{width:"180px"},onChange:i},{default:n(()=>[(f(!0),x(R,null,B(I.value,l=>(f(),v(y,{key:l.license_type_id,label:O(l),value:l.license_type_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),t(b,{label:e.$t("license.status")},{default:n(()=>[t(V,{modelValue:o.status,"onUpdate:modelValue":a[4]||(a[4]=l=>o.status=l),placeholder:e.$t("license.filterStatus"),clearable:"",style:{width:"140px"},onChange:i},{default:n(()=>[t(y,{label:e.$t("license.expired"),value:"expired"},null,8,["label"]),t(y,{label:e.$t("license.expiringSoon"),value:"expiring"},null,8,["label"]),t(y,{label:e.$t("license.normal"),value:"normal"},null,8,["label"])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),t(b,null,{default:n(()=>[t(u,{type:"primary",onClick:i},{default:n(()=>[d(r(e.$t("common.search")),1)]),_:1}),t(u,{onClick:H},{default:n(()=>[d(r(e.$t("common.reset")),1)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(U,null,{header:n(()=>[m("div",Se,[m("span",null,r(e.$t("license.records"))+" ("+r($.value)+")",1),m("div",null,[t(V,{modelValue:p.limit,"onUpdate:modelValue":a[5]||(a[5]=l=>p.limit=l),onChange:i,style:{width:"100px","margin-right":"10px"}},{default:n(()=>[(f(),x(R,null,B([10,20,50,100],l=>t(y,{label:`${l}/é¡µ`,value:l,key:l},null,8,["label","value"])),64))]),_:1},8,["modelValue"])])])]),default:n(()=>[j((f(),v(ae,{data:C.value,onSortChange:G,style:{width:"100%"}},{default:n(()=>[t(c,{prop:"employee_id",label:e.$t("employee.id"),width:"120",sortable:"custom"},null,8,["label"]),t(c,{prop:"name",label:e.$t("license.employee"),width:"150",sortable:"custom"},null,8,["label"]),t(c,{prop:"licenseName",label:e.$t("license.type"),width:"200",sortable:"custom"},{default:n(l=>[d(r(O(l.row.license)),1)]),_:1},8,["label"]),t(c,{prop:"number",label:e.$t("license.number"),width:"150",sortable:"custom"},null,8,["label"]),t(c,{prop:"expiry_date",label:e.$t("license.expiryDate"),width:"120",sortable:"custom"},null,8,["label"]),t(c,{prop:"days_remaining",label:e.$t("license.daysRemaining"),width:"120",sortable:"custom"},{default:n(l=>[m("span",{class:_e(M(l.row.days_remaining))},r(l.row.days_remaining),3)]),_:1},8,["label"]),t(c,{prop:"status",label:e.$t("license.status"),width:"120",sortable:"custom"},{default:n(l=>[t(D,{type:P(l.row.status),size:"small"},{default:n(()=>[d(r(A(l.row.status)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),t(c,{prop:"ocr_status",label:e.$t("license.ocrStatus"),width:"130"},{default:n(l=>[t(D,{type:W(l.row.ocr_status),size:"small"},{default:n(()=>[d(r(Z(l.row.ocr_status)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),t(c,{label:e.$t("license.file"),width:"90"},{default:n(l=>[l.row.file_url?(f(),v(ne,{key:0,content:l.row.file_url,placement:"top"},{default:n(()=>[t(u,{link:"",type:"primary",size:"small",onClick:N=>K(l.row.file_url)},{default:n(()=>[...a[8]||(a[8]=[d("ðŸ“Ž",-1)])]),_:2},1032,["onClick"])]),_:2},1032,["content"])):(f(),x("span",ke,"--"))]),_:1},8,["label"]),t(c,{label:e.$t("common.actions"),width:"200",fixed:"right"},{default:n(l=>[j((f(),v(u,{size:"small",onClick:N=>Q(l.row)},{default:n(()=>[d(r(e.$t("license.edit")),1)]),_:2},1032,["onClick"])),[[se,"LICENSE_EDIT"]]),l.row.ocr_status==="low_confidence"||l.row.ocr_status==="parsed"?(f(),v(u,{key:0,size:"small",type:"warning",onClick:N=>X(l.row)},{default:n(()=>[d(r(e.$t("license.confirmOcr")),1)]),_:2},1032,["onClick"])):ge("",!0)]),_:1},8,["label"])]),_:1},8,["data"])),[[ie,S.value]]),m("div",Ve,[t(oe,{"current-page":p.page,"onUpdate:currentPage":a[6]||(a[6]=l=>p.page=l),"page-size":p.limit,"onUpdate:pageSize":a[7]||(a[7]=l=>p.limit=l),"page-sizes":[10,20,50,100],total:$.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:i,onCurrentChange:i},null,8,["current-page","page-size","total"])])]),_:1})])}}}),Oe=he(Ee,[["__scopeId","data-v-f62e374e"]]);export{Oe as default};
