// src/controllers/departmentController.js
console.log('­ЪћД Loading department controller...');
try {
  const models = require('../models');
  console.log('­ЪћД Models available:', Object.keys(models));
  var Department = models.Department;
  var Employee = models.Employee;
  console.log('­ЪћД Department model:', !!Department, 'Employee model:', !!Employee);
} catch (error) {
  console.error('­ЪћД Error loading models:', error.message);
}
const { resolveError } = require('../utils/errorCodes');
const { Op } = require('sequelize');

function sendError(res, code, overrideMessage, details) {
  const { status, message, payload } = resolveError(code, overrideMessage, details);
  return res.standard(payload, { message, status });
}

// УјитЈќТЅђТюЅжЃежЌетѕЌУАе
const getDepartments = async (req, res) => {
  try {
    const { include_inactive = 'false' } = req.query;
    
    const where = {};
    if (include_inactive === 'false') {
      where.is_active = true;
    }

    const departments = await Department.findAll({
      where,
      include: [
        {
          model: Employee,
          as: 'manager',
          attributes: ['id', 'first_name', 'last_name', 'employee_id']
        },
        {
          model: Department,
          as: 'parent',
          attributes: ['id', 'name']
        },
        {
          model: Department,
          as: 'children',
          attributes: ['id', 'name']
        },
        {
          model: Employee,
          as: 'employees',
          attributes: ['id', 'first_name', 'last_name', 'employee_id'],
          where: { status: 'active' },
          required: false
        }
      ],
      order: [['sort_order', 'ASC'], ['name', 'ASC']]
    });

    // У«Ау«ЌТ»ЈСИфжЃежЌеуџётЉўтиЦТЋ░жЄЈ
    const departmentsWithStats = departments.map(dept => {
      const deptData = dept.toJSON();
      deptData.employee_count = deptData.employees ? deptData.employees.length : 0;
      return deptData;
    });

    res.standard(departmentsWithStats, {
      message: 'жЃежЌетѕЌУАеУјитЈќТѕљтіЪ',
      status: 200
    });
  } catch (error) {
    console.error('УјитЈќжЃежЌетѕЌУАетц▒У┤Ц:', error);
    return sendError(res, 'INTERNAL_ERROR', 'УјитЈќжЃежЌетѕЌУАетц▒У┤Ц', error.message);
  }
};

// тѕЏт╗║Тќ░жЃежЌе
const createDepartment = async (req, res) => {
  try {
    const { name, description, manager_id, parent_id, sort_order = 0 } = req.body;

    if (!name) {
      return sendError(res, 'VALIDATION_ERROR', 'жЃежЌетљЇуД░СИЇУЃйСИ║уЕ║');
    }

    // ТБђТЪЦжЃежЌетљЇуД░Тў»тљдти▓тГўтюе
    const existingDept = await Department.findOne({ where: { name } });
    if (existingDept) {
      return sendError(res, 'VALIDATION_ERROR', 'жЃежЌетљЇуД░ти▓тГўтюе');
    }

    // тдѓТъюТїЄт«џС║єСИ╗у«А№╝їТБђТЪЦСИ╗у«АТў»тљдтГўтюе
    if (manager_id) {
      const manager = await Employee.findByPk(manager_id);
      if (!manager) {
        return sendError(res, 'VALIDATION_ERROR', 'ТїЄт«џуџёСИ╗у«АСИЇтГўтюе');
      }
    }

    // тдѓТъюТїЄт«џС║єСИіу║ДжЃежЌе№╝їТБђТЪЦСИіу║ДжЃежЌеТў»тљдтГўтюе
    if (parent_id) {
      const parentDept = await Department.findByPk(parent_id);
      if (!parentDept) {
        return sendError(res, 'VALIDATION_ERROR', 'ТїЄт«џуџёСИіу║ДжЃежЌеСИЇтГўтюе');
      }
    }

    const department = await Department.create({
      name,
      description,
      manager_id,
      parent_id,
      sort_order,
      is_active: true
    });

    // У┐ћтЏът«їТЋ┤уџёжЃежЌеС┐АТЂ»
    const fullDepartment = await Department.findByPk(department.id, {
      include: [
        {
          model: Employee,
          as: 'manager',
          attributes: ['id', 'first_name', 'last_name', 'employee_id']
        },
        {
          model: Department,
          as: 'parent',
          attributes: ['id', 'name']
        }
      ]
    });

    res.standard(fullDepartment, {
      message: 'жЃежЌетѕЏт╗║ТѕљтіЪ',
      status: 201
    });
  } catch (error) {
    console.error('тѕЏт╗║жЃежЌетц▒У┤Ц:', error);
    return sendError(res, 'INTERNAL_ERROR', 'тѕЏт╗║жЃежЌетц▒У┤Ц', error.message);
  }
};

// ТЏ┤Тќ░жЃежЌеС┐АТЂ»
const updateDepartment = async (req, res) => {
  try {
    const { id } = req.params;
    const { name, description, manager_id, parent_id, sort_order, is_active } = req.body;

    const department = await Department.findByPk(id);
    if (!department) {
      return sendError(res, 'NOT_FOUND', 'жЃежЌеСИЇтГўтюе');
    }

    // тдѓТъюТЏ┤Тќ░тљЇуД░№╝їТБђТЪЦТќ░тљЇуД░Тў»тљдти▓тГўтюе
    if (name && name !== department.name) {
      const existingDept = await Department.findOne({ 
        where: { 
          name,
          id: { [Op.ne]: id }
        }
      });
      if (existingDept) {
        return sendError(res, 'VALIDATION_ERROR', 'жЃежЌетљЇуД░ти▓тГўтюе');
      }
    }

    // тдѓТъюТїЄт«џС║єСИ╗у«А№╝їТБђТЪЦСИ╗у«АТў»тљдтГўтюе
    if (manager_id) {
      const manager = await Employee.findByPk(manager_id);
      if (!manager) {
        return sendError(res, 'VALIDATION_ERROR', 'ТїЄт«џуџёСИ╗у«АСИЇтГўтюе');
      }
    }

    // тдѓТъюТїЄт«џС║єСИіу║ДжЃежЌе№╝їТБђТЪЦСИіу║ДжЃежЌеТў»тљдтГўтюеСИћСИЇтйбТѕљтЙфуј»т╝Ћуће
    if (parent_id) {
      if (parent_id === parseInt(id)) {
        return sendError(res, 'VALIDATION_ERROR', 'жЃежЌеСИЇУЃйУ«Йуй«УЄфти▒СИ║СИіу║ДжЃежЌе');
      }
      
      const parentDept = await Department.findByPk(parent_id);
      if (!parentDept) {
        return sendError(res, 'VALIDATION_ERROR', 'ТїЄт«џуџёСИіу║ДжЃежЌеСИЇтГўтюе');
      }
    }

    await department.update({
      name: name || department.name,
      description: description !== undefined ? description : department.description,
      manager_id: manager_id !== undefined ? manager_id : department.manager_id,
      parent_id: parent_id !== undefined ? parent_id : department.parent_id,
      sort_order: sort_order !== undefined ? sort_order : department.sort_order,
      is_active: is_active !== undefined ? is_active : department.is_active
    });

    // У┐ћтЏъТЏ┤Тќ░тљјуџёжЃежЌеС┐АТЂ»
    const updatedDepartment = await Department.findByPk(id, {
      include: [
        {
          model: Employee,
          as: 'manager',
          attributes: ['id', 'first_name', 'last_name', 'employee_id']
        },
        {
          model: Department,
          as: 'parent',
          attributes: ['id', 'name']
        }
      ]
    });

    res.standard(updatedDepartment, {
      message: 'жЃежЌеТЏ┤Тќ░ТѕљтіЪ',
      status: 200
    });
  } catch (error) {
    console.error('ТЏ┤Тќ░жЃежЌетц▒У┤Ц:', error);
    return sendError(res, 'INTERNAL_ERROR', 'ТЏ┤Тќ░жЃежЌетц▒У┤Ц', error.message);
  }
};

// тѕажЎцжЃежЌе
const deleteDepartment = async (req, res) => {
  try {
    const { id } = req.params;

    const department = await Department.findByPk(id);
    if (!department) {
      return sendError(res, 'NOT_FOUND', 'жЃежЌеСИЇтГўтюе');
    }

    // ТБђТЪЦТў»тљдУ┐ўТюЅтЉўтиЦтюеУ»ЦжЃежЌе
    const employeeCount = await Employee.count({
      where: { 
        department_id: id,
        status: 'active'
      }
    });
    
    if (employeeCount > 0) {
      return sendError(res, 'VALIDATION_ERROR', 'У»ЦжЃежЌеУ┐ўТюЅтЉўтиЦ№╝їТЌаТ│ЋтѕажЎц');
    }

    // ТБђТЪЦТў»тљдУ┐ўТюЅтГљжЃежЌе
    const childrenCount = await Department.count({
      where: { 
        parent_id: id,
        is_active: true
      }
    });
    
    if (childrenCount > 0) {
      return sendError(res, 'VALIDATION_ERROR', 'У»ЦжЃежЌеУ┐ўТюЅтГљжЃежЌе№╝їТЌаТ│ЋтѕажЎц');
    }

    // Уй»тѕажЎц
    await department.destroy();

    res.standard(null, {
      message: 'жЃежЌетѕажЎцТѕљтіЪ',
      status: 200
    });
  } catch (error) {
    console.error('тѕажЎцжЃежЌетц▒У┤Ц:', error);
    return sendError(res, 'INTERNAL_ERROR', 'тѕажЎцжЃежЌетц▒У┤Ц', error.message);
  }
};

// УјитЈќжЃежЌетЉўтиЦ
const getDepartmentEmployees = async (req, res) => {
  try {
    const { id } = req.params;
    const { page = 1, limit = 50 } = req.query;

    const department = await Department.findByPk(id);
    if (!department) {
      return sendError(res, 'NOT_FOUND', 'жЃежЌеСИЇтГўтюе');
    }

    const offset = (page - 1) * limit;
    
    const { count, rows: employees } = await Employee.findAndCountAll({
      where: { 
        department_id: id,
        status: 'active'
      },
      attributes: [
        'id', 'employee_id', 'first_name', 'last_name', 
        'position', 'phone', 'email', 'start_date', 'status'
      ],
      limit: parseInt(limit),
      offset: parseInt(offset),
      order: [['employee_id', 'ASC']]
    });

    res.standard({
      employees,
      pagination: {
        current_page: parseInt(page),
        per_page: parseInt(limit),
        total: count,
        total_pages: Math.ceil(count / limit)
      }
    }, {
      message: 'жЃежЌетЉўтиЦтѕЌУАеУјитЈќТѕљтіЪ',
      status: 200
    });
  } catch (error) {
    console.error('УјитЈќжЃежЌетЉўтиЦтц▒У┤Ц:', error);
    return sendError(res, 'INTERNAL_ERROR', 'УјитЈќжЃежЌетЉўтиЦтц▒У┤Ц', error.message);
  }
};

// УјитЈќжЃежЌеУђЃтІцу╗ЪУ«А
const getDepartmentAttendanceStats = async (req, res) => {
  try {
    const { id } = req.params;
    const { date = new Date().toISOString().split('T')[0] } = req.query;

    const department = await Department.findByPk(id);
    if (!department) {
      return sendError(res, 'NOT_FOUND', 'жЃежЌеСИЇтГўтюе');
    }

    // УјитЈќжЃежЌеТЅђТюЅтЉўтиЦ
    const employees = await Employee.findAll({
      where: { 
        department_id: id,
        status: 'active'
      },
      attributes: ['id', 'employee_id']
    });

    if (employees.length === 0) {
      return res.standard({
        date,
        total_employees: 0,
        present: 0,
        late: 0,
        absent: 0,
        leave: 0
      }, {
        message: 'жЃежЌеУђЃтІцу╗ЪУ«АУјитЈќТѕљтіЪ',
        status: 200
      });
    }

    // т«ъуј░уюЪт«ъуџёУђЃтІцу╗ЪУ«АУ«Ау«Ќ
    let stats = { present: 0, late: 0, absent: 0, leave: 0 };
    
    if (employees.length > 0) {
      // УјитЈќжЃежЌетЉўтиЦС╗іТЌЦуГЙтѕ░У«░тйЋ
      const CheckIn = require('../models').CheckIn;
      const todayCheckins = await CheckIn.findAll({
        where: {
          checkin_time: {
            [Op.gte]: new Date(date + ' 00:00:00'),
            [Op.lt]: new Date(date + ' 23:59:59')
          }
        },
        include: [{
          model: Employee,
          attributes: ['employee_id'],
          where: { 
            department_id: id,
            status: 'active'
          },
          required: true
        }],
        raw: true
      });

      // ТїЅтЉўтиЦтѕєу╗ёу╗ЪУ«А
      const employeeCheckins = {};
      todayCheckins.forEach(checkin => {
        const empId = checkin['Employee.employee_id'];
        if (!employeeCheckins[empId]) {
          employeeCheckins[empId] = { checkin: null };
        }
        
        if (checkin.checkin_type === 'in') {
          employeeCheckins[empId].checkin = new Date(checkin.checkin_time);
        }
      });

      // У«Ау«ЌтЄ║тІцуіХТђЂ
      const lateThreshold = 9.25; // 9:15 AM
      
      Object.values(employeeCheckins).forEach(emp => {
        if (emp.checkin) {
          const checkinHour = emp.checkin.getHours() + emp.checkin.getMinutes() / 60;
          if (checkinHour <= lateThreshold) {
            stats.present++;
          } else {
            stats.late++;
          }
        }
      });

      // ТюфуГЙтѕ░уџётЉўтиЦСИ║у╝║тІц
      stats.absent = employees.length - stats.present - stats.late;
    }

    const finalStats = {
      date,
      total_employees: employees.length,
      ...stats
    };

    res.standard(finalStats, {
      message: 'жЃежЌеУђЃтІцу╗ЪУ«АУјитЈќТѕљтіЪ',
      status: 200
    });
  } catch (error) {
    console.error('УјитЈќжЃежЌеУђЃтІцу╗ЪУ«Атц▒У┤Ц:', error);
    return sendError(res, 'INTERNAL_ERROR', 'УјитЈќжЃежЌеУђЃтІцу╗ЪУ«Атц▒У┤Ц', error.message);
  }
};

module.exports = {
  getDepartments,
  createDepartment,
  updateDepartment,
  deleteDepartment,
  getDepartmentEmployees,
  getDepartmentAttendanceStats
};